# ⚙️ 设置使用指南

## ❓ 什么是设置?

**设置** 是 Tsukuyomi 的核心配置中心，让您可以自定义 AI 模型、网络代理、数据同步、爬虫行为等各项功能，打造最适合您的翻译工作流程。

所有设置都会自动保存到本地，您可以随时调整配置而不用担心丢失。

---

## 🚀 快速开始

### 📱 打开设置

有多种方式可以打开设置弹窗：

1. ⬅️ **从左侧导航栏**:
   - 📍 位置: 左侧导航栏
   - 🖱️ 按钮: **⚙️ 设置** 图标

点击后，设置对话框会弹出，显示所有可用的配置选项卡。

### ❌ 关闭设置

关闭设置弹窗：

- 🖱️ **点击关闭按钮**: 弹窗右上角的 **✕** 图标

> 💡 **提示**: 所有设置会自动保存，下次打开会保持最后修改的配置。

---

## 📚 设置选项卡详解

### 1️⃣ 🤖 AI 模型

**用途**: 配置默认使用的 AI 模型，以及为不同任务类型指定最合适的模型。

**🎮 主要功能**:

- 🌐 **翻译默认模型**: 选择用于初始翻译任务的默认 AI 模型
- ✨ **润色/校对默认模型**: 选择用于润色和校对任务的默认 AI 模型
- 📖 **术语翻译/章节摘要默认模型**: 选择用于术语表翻译和章节摘要的默认 AI 模型
- 💬 **助手对话默认模型**: 选择用于聊天助手的默认 AI 模型

**⭐ 推荐配置**:

1. 🌐 **翻译默认**: 使用大型推理模型（DeepSeek-R1, GPT-o1, Claude 4 Opus）— 适合处理复杂和长难句
2. ✨ **润色默认**: 使用快速高质量模型（Claude 3.5 Sonnet, Gemini 2.0 Flash）— 快速优化译文
3. 📖 **术语翻译/章节摘要**: 使用快速的模型（Gemini 2.0 Flash, DeepSeek-V3）— 成本低、速度快
4. 💬 **助手对话**: 使用大型推理模型（DeepSeek-R1, GPT-o1, Claude 4 Opus）— 提供最佳的对话质量

**提示**: 您可以在 **AI 模型** 页面添加和管理所有可用的 AI 模型。在此设置中选择的是默认模型，执行任务时可以随时手动切换。

> 📖 **详细指南**: 查看 [AI 模型配置指南](/help/ai-models-guide) 了解如何添加和配置 AI 模型。

---

### 2️⃣ 🌐 代理设置

**用途**: 配置 CORS 代理服务器，绕过浏览器的跨域限制，使浏览器版本能够正常访问 AI API 和抓取网页内容。

**注意**: 此选项卡仅在 **浏览器版本** 中显示。**桌面应用 (Electron)** 不受 CORS 限制，因此不需要此功能。

**什么是 CORS？**

CORS（跨源资源共享）是浏览器的一种安全机制，会阻止网页直接访问不同域名的 API。由于大多数 AI 服务的 API 和小说网站不支持从浏览器直接调用，因此需要通过 CORS 代理服务器来转发请求。

---

#### 核心功能

##### 1. 启用代理

**功能**: 全局开启或关闭代理功能

- **启用**: 爬虫和网络工具将通过代理服务器访问网页
- **禁用**: 直接尝试访问（可能因 CORS 限制而失败）

**提示**: 在浏览器环境中，强烈建议启用代理以确保正常功能。

##### 2. 选择代理服务

**功能**: 从预配置的代理列表中选择默认使用的代理服务

每个代理服务包含：

- **名称**: 代理服务的标识名称
- **URL**: 代理服务器的地址模板（如：`http://abc.xyz?url={url}`）
- **描述**: 代理服务的简要说明（可选）

**使用方式**:

1. 从下拉列表中选择一个代理服务
2. 系统会自动应用该代理的 URL
3. 您也可以手动输入自定义的代理 URL

**URL 格式说明**:

```
http://your-proxy.com/api?url={url}
```

其中 `{url}` 是占位符，会被替换为实际要请求的目标网址。

##### 3. 自动切换代理服务 ⭐

**功能**: 当代理服务遇到错误时，自动切换到下一个可用的代理

**工作原理**:

1. 当前代理请求失败时，系统会：
   - 检查是否有为该网站配置的备用代理
   - 按优先级顺序尝试每个备用代理
   - 找到可用代理后，自动切换并继续请求

2. 如果启用了 **自动添加映射**：
   - 成功切换的代理会自动记录到该网站的映射中
   - 下次访问该网站时会优先使用成功的代理

**推荐配置**:

- ✅ **启用**: 提高请求成功率，避免单个代理失效导致操作中断
- ✅ **同时启用自动添加映射**: 让系统自动学习最佳代理配置

---

#### 代理列表管理 📋

**功能**: 管理所有可用的 CORS 代理服务

##### 添加代理

1. 点击 **添加代理** 按钮
2. 填写代理信息：
   - **名称**: 如 "Cloudflare Workers 代理"
   - **URL**: 如 `https://your-worker.workers.dev/?url={url}`
   - **描述**（可选）: 如 "自建 Cloudflare Workers 代理，速度快"
3. 点击 **保存**

##### 编辑代理

1. 点击代理列表中的 ✏️ **编辑** 按钮
2. 修改代理信息
3. 点击 **保存**

##### 测试代理

1. 点击代理列表中的 🚀 **测试** 按钮
2. 系统会使用该代理访问测试网址（duckduckgo.com）
3. 测试结果会显示在通知中：
   - ✅ **成功**: 代理可正常使用
   - ❌ **失败**: 代理不可用或超时

**提示**: 建议在添加代理后立即测试，确保其可用性。

##### 删除代理

1. 点击代理列表中的 🗑️ **删除** 按钮
2. 代理会被立即删除
3. 如果删除的是当前选中的代理，系统会自动切换到其他可用代理

##### 调整代理顺序

**功能**: 通过拖拽调整代理的优先级顺序

1. 在代理列表中，拖动代理行左侧的 **拖拽图标**
2. 将代理拖到目标位置
3. 释放鼠标，顺序会自动保存

**重要性**: 代理的顺序决定了自动切换时的尝试顺序。建议将最可靠、速度最快的代理放在前面。

---

#### 网站-代理映射 🗺️

**功能**: 为特定网站配置专属的代理服务列表和优先级

##### 为什么需要映射？

不同的网站可能对代理服务有不同的要求：

- 某些代理服务可能被特定网站封禁
- 某些代理服务对特定地区的网站访问速度更快
- 您可以为重要网站配置多个备用代理，提高成功率

##### 添加网站映射

1. 在 **网站-代理映射** 区域，输入网站信息：
   - **网站**: 输入域名（如 `kakuyomu.jp`）或完整 URL（如 `https://kakuyomu.jp`）
   - 系统会自动提取根域名
2. 选择要使用的代理服务
3. 点击 **添加**

**示例**:

```
网站: kakuyomu.jp
代理: Cloudflare Workers 代理
```

##### 编辑网站映射

1. 点击映射列表中的 ✏️ **编辑映射** 按钮
2. 在编辑对话框中：
   - **启用/禁用** 该映射规则
   - **添加代理**: 从可用代理列表中选择（最多 3 个）
   - **移除代理**: 点击代理旁的 ✕ 按钮
   - **调整顺序**: 使用 ⬆️ ⬇️ 按钮调整代理的优先级
3. 点击 **保存**

##### 启用/禁用映射

**功能**: 在不删除映射的情况下临时禁用某个网站的特殊代理配置

- **启用**: 访问该网站时使用配置的代理列表
- **禁用**: 访问该网站时使用默认代理

**使用场景**: 当某个网站的映射配置需要调整时，可以先禁用测试默认代理是否可用。

##### 代理数量限制

每个网站最多可配置 **3 个代理**：

1. **第一优先级**: 优先尝试的代理
2. **第二优先级**: 第一个失败时的备用代理
3. **第三优先级**: 前两个都失败时的最后备选

**提示**: 3 个代理已足够应对大部分情况。如果 3 个代理都失败，系统会回退到默认代理。

##### 自动生成映射

当启用了 **自动切换代理** 和 **自动添加映射** 后：

- 系统会自动记录成功访问每个网站的代理
- 下次访问该网站时会优先使用记录的代理
- 无需手动配置，让系统自动优化代理选择

---

#### 常用 CORS 代理服务

##### 1. 自建代理（推荐）⭐

**Cloudflare Workers 代理**:

- **优势**: 免费、快速、全球 CDN 加速
- **教程**: [CORS Anywhere on Cloudflare Workers](https://github.com/Zibri/cloudflare-cors-anywhere)
- **URL 格式**: `https://your-worker.workers.dev/?url={url}`

**Vercel/Netlify 代理**:

- **优势**: 免费、易部署
- **工具**: 使用 [CORS Anywhere](https://github.com/Rob--W/cors-anywhere) 部署
- **URL 格式**: `https://your-app.vercel.app/{url}` 或 `https://your-app.vercel.app/api?url={url}`

##### 2. 公共代理（谨慎使用）

**安全警告**:

- ⚠️ 公共代理可能不稳定
- ⚠️ 您的请求会经过第三方服务器（隐私风险）
- ⚠️ 可能有请求频率限制

**建议**: 仅用于测试，生产环境请使用自建代理。

---

#### 最佳实践

##### 1. 代理配置策略

**多代理组合**:

```
✅ 主力代理: 自建 Cloudflare Workers（速度快、稳定）
✅ 备用代理 1: 自建 Vercel 代理（备份）
✅ 备用代理 2: 另一个区域的代理（地域冗余）
```

**优先级排序**:

1. 速度最快的代理
2. 稳定性最好的代理
3. 覆盖范围最广的代理

##### 2. 网站映射配置

**重要网站配置多个代理**:

```
kakuyomu.jp → [代理 A, 代理 B, 代理 C]
syosetu.com → [代理 A, 代理 C]
```

**测试网站仅配置一个代理**:

```
test-site.com → [代理 A]
```

##### 3. 自动化配置

**推荐设置**:

- ✅ 启用代理
- ✅ 启用自动切换代理服务
- ✅ 启用自动添加映射

**好处**:

- 自动学习最佳代理配置
- 减少手动维护工作
- 提高请求成功率

##### 4. 定期维护

**定期检查**:

- 🔍 测试每个代理的可用性
- 🔍 删除长期失效的代理
- 🔍 检查映射配置是否合理
- 🔍 更新代理服务器地址（如果变更）

---

#### 故障排查

**问题 1: 代理测试失败**

可能原因:

- ❌ 代理服务器地址错误
- ❌ 代理服务器不可用或关闭
- ❌ URL 格式不正确（缺少 `{url}` 占位符）
- ❌ 网络连接问题

解决方案:

1. 检查代理 URL 格式是否正确
2. 尝试在浏览器中直接访问代理服务器
3. 检查代理服务器的运行状态
4. 更换其他代理测试

**问题 2: 自动切换不工作**

可能原因:

- ❌ 未启用自动切换功能
- ❌ 没有为网站配置备用代理
- ❌ 所有代理都不可用

解决方案:

1. 确保 **启用代理** 和 **自动切换代理服务** 都已开启
2. 为常用网站配置多个备用代理
3. 测试每个代理的可用性

**问题 3: 某些网站无法访问**

可能原因:

- ❌ 该网站封禁了代理服务器的 IP
- ❌ 代理服务器不支持该网站的请求方式
- ❌ 网站本身需要特殊的身份验证

解决方案:

1. 为该网站配置专属的代理
2. 尝试使用不同区域的代理服务器
3. 检查网站是否需要登录（在爬虫设置中配置 Cookie）

---

#### 安全建议

1. **使用 HTTPS 代理**: 确保代理服务器使用 HTTPS 协议，保护数据传输安全
2. **自建代理优先**: 避免使用不可信的公共代理，防止数据泄露
3. **定期更换**: 如果代理服务器被封禁，及时更换新的代理
4. **监控使用**: 定期检查代理的请求日志（如果可用），确保没有异常活动

---

**提示**: 代理设置是浏览器版本的关键功能。花时间配置好代理系统，可以显著提升使用体验和成功率。如果条件允许，建议使用桌面版以获得更好的性能，无需配置代理。

---

### 3️⃣ 🔑 API Keys

**用途**: 配置第三方服务的 API Keys，目前支持 **Tavily 搜索 API**。

> ⚠️ **注意**: AI 模型的 API Keys（如 OpenAI、Anthropic、Google 等）是在 **AI 模型页面** 中配置的，而不是在这里。

---

#### Tavily 搜索 API

**功能**: 为 AI 聊天助手提供网络搜索能力

当您在聊天助手中请求 AI 搜索网络信息时，系统会使用 Tavily API 来获取最新的网络内容。

##### 获取 API Key

1. 访问 [tavily.com](https://tavily.com/)
2. 注册账号（支持 Google 账号快速登录）
3. 在控制台中找到您的 API Key
4. 复制 API Key（格式：`tvly-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`）

**免费计划**: Tavily 提供免费计划，每月有足够的搜索次数供个人使用。

##### 配置 API Key

1. 在 **API Key** 输入框中粘贴您的 Tavily API Key
2. 点击 **保存** 按钮
3. 看到绿色的 **✓ 已配置** 提示即表示配置成功

##### 配置状态

- **✓ 已配置**: API Key 已保存，网络搜索功能可用
- **⚠ 未配置**: 未设置 API Key，聊天助手的网络搜索功能将被禁用

##### 使用场景

聊天助手可以通过 Tavily 搜索获取：

- 最新的技术文档和教程
- 实时新闻和信息
- 翻译相关的参考资料
- 术语的权威解释

**示例对话**:

```
💬 "搜索一下「異世界転生」这个词的最新流行译法"
🤖 AI 会使用 Tavily 搜索网络，找到最新的翻译趋势和用法
```

##### 安全性

- **本地存储**: API Key 安全地存储在您的本地浏览器中
- **不会上传**: API Key 不会被上传到服务器
- **仅授权使用**: 只有在您明确要求 AI 搜索时才会调用 Tavily API

##### 更新或删除 API Key

**更新**: 直接在输入框中输入新的 API Key，点击保存即可

**删除**: 清空输入框内容，点击保存即可删除 API Key（将禁用搜索功能）

---

**提示**: 如果您不需要 AI 聊天助手的网络搜索功能，可以不配置 Tavily API Key。所有其他功能（翻译、润色、校对等）都不需要 Tavily API。

---

### 4️⃣ 🔄 同步设置

**用途**: 使用 **GitHub Gist** 同步您的设置、AI 模型配置和书籍数据，实现多设备数据同步和历史版本管理。

**核心特性**:

- 🔐 **私有存储**: 所有数据保存在您的私有 GitHub Gist 中
- 📜 **版本历史**: 自动保存每次同步的修订历史
- 🔄 **自动同步**: 定时自动同步数据
- ⏪ **版本恢复**: 可以恢复到任意历史版本
- 🗑️ **恢复已删除**: 发现并恢复意外删除的书籍

---

#### 准备工作

##### 1. 创建 GitHub Personal Access Token

1. 登录 GitHub，进入 **Settings** → **Developer settings** → **Personal access tokens** → **Tokens (classic)**
2. 点击 **Generate new token (classic)**
3. 设置 **Note**（如 "Tsukuyomi Sync"）
4. **权限设置**: 勾选 `gist`（这是唯一需要的权限）
5. 设置 **Expiration**（建议选择 "No expiration"）
6. 点击 **Generate token**
7. **重要**: 立即复制并保存 Token（页面关闭后无法再次查看）

**Token 格式**: `ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`

##### 2. 获取

GitHub 用户名

您的 GitHub 用户名（不是邮箱），例如：`octocat`

---

#### 基础配置

##### 1. 启用 Gist 同步

勾选 **启用 Gist 同步** 复选框

##### 2. 配置凭证

- **GitHub 用户名**: 输入您的 GitHub 用户名
- **GitHub Personal Access Token**: 粘贴刚创建的 Token

##### 3. 配置 Gist ID（可选）

- **首次同步**: 留空，系统会自动创建新的 Gist
- **已有 Gist**: 输入现有的 Gist ID（在 Gist URL 中可以找到）

**Gist ID 位置**:

```
https://gist.github.com/{username}/{gist_id}
                                    ^^^^^^^^
                                    这是 Gist ID
```

##### 4. 验证 Token

点击 **验证 Token** 按钮，确保凭证配置正确

- ✅ **验证成功**: Token 有效，可以开始同步
- ❌ **验证失败**: 检查用户名和 Token 是否正确

---

#### 手动同步

##### 上传到 Gist（推送）

**功能**: 将本地数据推送到 GitHub Gist

1. 点击 **上传到 Gist** 按钮
2. 系统会：
   - 收集所有本地数据（设置、AI 模型配置、书籍数据）
   - 压缩并分块（如果数据量大）
   - 上传到 Gist
   - 创建新的修订版本

**首次上传**: 如果未配置 Gist ID，系统会自动创建新的 Gist 并保存 ID

**更新 Gist**: 如果已配置 Gist ID，系统会更新现有 Gist

##### 从 Gist 下载（拉取）

**功能**: 从 GitHub Gist 下载数据并合并到本地

1. 点击 **从 Gist 下载** 按钮
2. 系统会：
   - 从 Gist 下载最新数据
   - 与本地数据智能合并
   - 检测已删除的项目（如果有）

**智能合并规则**:

- **新书籍**: 自动添加到本地
- **已有书籍**: 比较 `lastEdited` 时间，保留较新的版本
- **已删除书籍**: 如果远程书籍已被删除，提示是否恢复

**恢复已删除的书籍**:

- 如果下载时发现本地有被删除的书籍，会弹出恢复对话框
- 您可以选择恢复哪些书籍
- 支持批量恢复

---

#### 自动同步 ⭐

**功能**: 定时自动同步本地数据到 Gist，无需手动操作

##### 启用自动同步

1. 勾选 **启用自动同步** 复选框
2. 设置 **同步间隔**（1-1440 分钟）
   - 推荐：5-30 分钟
   - 最短：1 分钟
   - 最长：1440 分钟（24 小时）

##### 工作原理

- 系统会在后台定时运行同步任务
- 每次同步会自动上传本地数据到 Gist
- 同步完成后会显示通知
- 同步失败会自动重试

##### 最佳实践

**推荐配置**:

```
√ 启用 Gist 同步
√ 启用自动同步
同步间隔: 15 分钟
```

**适用场景**:

- ✅ 多设备工作，需要频繁同步
- ✅ 担心数据丢失，需要自动备份
- ✅ 长时间翻译，希望定期保存进度

**注意事项**:

- 自动同步会消耗 GitHub API 配额
- 建议不要设置过短的同步间隔（< 5 分钟）
- 可以随时手动上传，无需等待自动同步

---

#### 修订历史 📜

**功能**: 查看所有同步版本的历史记录，并可以恢复到任意版本

##### 查看修订历史

在同步设置页面底部可以看到 **修订历史** 区域

每个修订版本显示：

- **版本号**: Git commit SHA（前 7 位）
- **提交时间**: 相对时间和绝对时间
- **变更统计**:
  - **+N**: 新增或增加的文件数
  - **-N**: 删除或减少的文件数

##### 展开修订详情

点击修订版本行可以展开查看详细文件变更：

**文件状态标识**:

- **📄 应用设置**: tsukuyomi-settings.json
- **📚 书籍**: 显示书名
- **🗑️ 已删除**: 书籍已被删除

**文件变更信息**:

- **状态**: 新增、修改、删除
- **大小**: 文件大小
- **大小差异**: 相比上一版本的变化

##### 恢复到指定版本

1. 在修订历史中找到要恢复的版本
2. 点击该版本的 **恢复** 按钮
3. 确认恢复操作
4. 系统会：
   - 清空本地所有数据
   - 下载指定版本的完整数据
   - 应用到本地
   - 检测是否有已删除的项目需要恢复

**警告**: 恢复到历史版本会 **完全覆盖** 当前本地数据，请谨慎操作！

**推荐做法**: 恢复前先手动上传一次当前数据作为备份

---

#### 删除 Gist

**功能**: 从 GitHub 永久删除 Gist（不影响本地数据）

**操作步骤**:

1. 在同步设置页面，找到删除选项（通常在底部）
2. 点击 **删除 Gist** 按钮
3. 确认删除（此操作不可撤销）
4. Gist 及其所有修订历史将被永久删除

**注意**:

- ❌ 删除 Gist 不会影响您的本地数据
- ❌ 删除后无法恢复 Gist 中的任何数据
- ✅ 删除后可以重新创建新的 Gist

---

#### 同步数据范围

系统会同步以下数据：

##### 1. 应用设置

- AI 模型配置（包含 API Keys）
- 代理设置
- 同步设置本身
- 其他应用偏好

##### 2. AI 模型列表

- 所有已配置的 AI 模型
- 模型参数和默认任务设置

##### 3. 书籍数据（每本书独立存储）

- 书籍元数据（标题、作者、封面等）
- 章节列表
- 翻译内容（所有段落的原文和译文）
- 术语表
- 角色设定
- 记忆（Memories）

**数据分块**: 单个文件超过 1MB 时会自动分块存储，下载时自动合并

---

#### 常见问题

**Q: 同步会覆盖本地数据吗？**
A:

- **上传**: 不会，只是将本地数据推送到 Gist
- **下载**: 会智能合并，保留最新版本的数据
- **恢复版本**: 会完全覆盖本地数据

**Q: 同步数据安全吗？**
A:

- ✅ Gist 是私有的，只有您可以访问
- ✅ Token 存储在本地，不会上传到服务器
- ✅ 支持版本历史，可以恢复数据
- ⚠️ 建议定期更换 GitHub Token

**Q: 同步失败怎么办？**
A:

1. 检查网络连接
2. 验证 Token 是否有效
3. 检查 GitHub API 配额是否用完
4. 查看错误提示，按提示操作

**Q: 可以在多设备间同步吗？**
A:

- ✅ 可以！在每个设备上配置相同的 Gist ID 和凭证即可
- ⚠️ 建议：
  - 一个设备上传后，其他设备下载
  - 避免多设备同时上传（可能冲突）
  - 使用自动同步时要小心数据冲突

**Q: GitHub 有请求限制吗？**
A:

- 认证用户：5000 requests/hour
- 对于正常使用，配额完全足够
- 如果超限，等待一小时后配额会重置

**Q: 同步数据会很大吗？**
A:

- 单本书籍数据通常在几百 KB 到几 MB
- Gist 单文件最大 10MB（系统会自动分块）
- 建议定期清理不需要的旧书籍

**Q: 修订历史会保留多久？**
A:

- GitHub Gist 的修订历史永久保留
- 您可以随时恢复到任意历史版本
- 如果想清理历史，只能删除 Gist 并重新创建

---

#### 故障排查

**问题 1: Token 验证失败**

可能原因:

- ❌ Token 不正确或已过期
- ❌ Token 权限不包含 `gist`
- ❌ 用户名输入错误

解决方案:

1. 重新生成 Token，确保勾选 `gist` 权限
2. 检查用户名是否正确
3. 确保 Token 完整复制，没有多余空格

**问题 2: 上传失败**

可能原因:

- ❌ 网络连接问题
- ❌ GitHub API 配额用完
- ❌ Gist ID 不正确（如果已配置）
- ❌ 数据太大（单个文件 > 10MB）

解决方案:

1. 检查网络连接
2. 等待一小时让 API 配额重置
3. 清空 Gist ID，让系统重新创建
4. 删除不需要的书籍，减小数据量

**问题 3: 下载失败**

可能原因:

- ❌ Gist ID 不存在
- ❌ 没有访问权限
- ❌ Gist 已被删除

解决方案:

1. 检查 Gist ID 是否正确
2. 确保 Token 对应的账号拥有该 Gist
3. 在 GitHub 上检查 Gist 是否存在

**问题 4: 自动同步不工作**

可能原因:

- ❌ 未启用 Gist 同步
- ❌ 未启用自动同步
- ❌ 浏览器标签页未保持打开

解决方案:

1. 确保两个开关都已启用
2. 保持浏览器标签页打开（或使用桌面版）
3. 检查控制台是否有错误信息

---

#### 最佳实践

##### 1. 定期备份

**推荐配置**:

```
√ 启用 Gist 同步
√ 启用自动同步（15 分钟间隔）
定期手动上传重要更改
```

##### 2. 多设备同步策略

**主设备**（如家用电脑）:

- 启用自动同步（上传）
- 每次工作结束手动上传一次

**辅助设备**（如公司电脑）:

- 启用 Gist 同步
- 每次工作开始手动下载一次
- 工作结束手动上传一次
- 谨慎使用自动同步（避免冲突）

##### 3. 安全建议

1. **Token 管理**:
   - 定期更换 Token（每 3-6 个月）
   - 不要分享 Token
   - Token 泄露立即撤销并重新生成

2. **Gist 隐私**:
   - 确保 Gist 设置为 **Secret**（私有）
   - 不要将 Gist ID 分享给他人
   - 定期检查 Gist 的访问权限

3. **数据保护**:
   - 重要更改前手动上传备份
   - 定期查看修订历史
   - 必要时导出本地备份（使用导入/导出功能）

##### 4. 性能优化

1. **定期清理**:
   - 删除不需要的旧书籍
   - 清理无用的翻译版本
   - 减小同步数据量

2. **合理设置同步间隔**:
   - 活跃翻译时：10-15 分钟
   - 偶尔使用时：30-60 分钟
   - 仅手动同步：禁用自动同步

---

**提示**: GitHub Gist 同步是 Tsukuyomi 最强大的数据管理功能之一。花时间正确配置，可以有效保护您的翻译数据，实现跨设备无缝协作。

---

### 5️⃣ 🕷️ 爬虫设置

**用途**: 配置网页爬虫的并发请求数量，避免超过 API 限制或被网站封禁。

---

#### 并发数限制

**功能**: 控制同时进行的网络请求数量

**配置范围**: 1-10 个并发请求

**推荐值**: 3

---

#### 工作原理

当您从在线小说网站批量抓取章节时，系统会：

1. 将待抓取的章节分组
2. 每组最多包含 N 个章节（N = 并发数限制）
3. 同时发送该组的所有请求
4. 等待该组请求完成后，再处理下一组

**示例**：

```
并发数限制 = 3
待抓取章节 = 10 章

执行顺序：
第 1 组: 章节 1, 2, 3   （同时请求）
第 2 组: 章节 4, 5, 6   （同时请求）
第 3 组: 章节 7, 8, 9   （同时请求）
第 4 组: 章节 10        （单独请求）
```

---

#### 如何选择合适的并发数

##### 并发数过低（1-2）

**优点**:

- ✅ 对服务器压力最小
- ✅ 最不容易被封禁
- ✅ 适合限制严格的网站

**缺点**:

- ❌ 抓取速度慢
- ❌ 大量章节时耗时较长

**适用场景**:

- 网站有严格的速率限制
- 曾因请求过快被封禁
- 不着急完成抓取

##### 并发数适中（3-5）⭐ 推荐

**优点**:

- ✅ 速度与稳定性平衡
- ✅ 适合大多数网站
- ✅ 被封禁风险较低

**缺点**:

- 对于特别严格的网站可能仍需降低

**适用场景**:

- 大多数在线小说网站
- 日常翻译工作
- 首选配置

##### 并发数较高（6-10）

**优点**:

- ✅ 抓取速度最快
- ✅ 适合本地测试服务器

**缺点**:

- ❌ 容易触发反爬虫机制
- ❌ 可能被临时或永久封禁
- ❌ 对服务器压力大

**适用场景**:

- 自己搭建的测试服务器
- 明确允许高并发的 API
- ⚠️ **不推荐用于公开网站**

---

#### 设置并发数

1. 在 **并发数限制** 输入框中输入数字（1-10）
2. 或使用 **+/-** 按钮调整
3. 设置会自动保存

**当前推荐**:

```
并发数限制: 3
```

---

#### 最佳实践

##### 1. 从保守开始

首次使用新网站时：

- 从低并发开始（1-2）
- 观察是否有错误或封禁
- 逐步提高并发数

##### 2. 观察响应

抓取过程中注意：

- **成功率**: 如果频繁失败，降低并发数
- **速度**: 如果太慢且没有错误，可适当提高
- **错误信息**: 如果看到 "Too Many Requests" (429)，立即降低并发数

##### 3. 不同网站不同策略

**大型商业网站** (如 Kakuyomu, Syosetu):

- 并发数: 2-3
- 原因: 有完善的反爬虫机制

**个人博客或小网站**:

- 并发数: 1-2
- 原因: 服务器资源有限，容易过载

**本地或测试服务器**:

- 并发数: 5-10
- 原因: 自己控制，无限制

##### 4. 结合代理使用

如果使用 CORS 代理（浏览器版本）:

- 代理服务器也有限制
- 考虑代理的承受能力
- 可能需要进一步降低并发数

---

#### 常见问题

**Q: 为什么不是并发数越高越好？**

A:

- ❌ 高并发会被网站识别为爬虫或攻击
- ❌ 可能导致 IP 被封禁
- ❌ 违反网站服务条款
- ✅ 合理的并发数既高效又安全

**Q: 被封禁了怎么办？**

A:

1. 立即停止抓取
2. 降低并发数到 1
3. 等待一段时间（通常几小时到一天）
4. 考虑更换 IP 或使用代理
5. 重新尝试，从低并发开始

**Q: 并发数会影响浏览器性能吗？**

A:

- 对于 1-5: 几乎无影响
- 对于 6-10: 可能占用更多内存和 CPU
- 桌面版比浏览器版性能更好

**Q: 不同章节来源可以不同并发数吗？**

A:

- 目前并发数是全局设置
- 如果抓取不同网站，建议：
  - 先抓一个网站
  - 调整并发数
  - 再抓另一个网站

**Q: 并发数设置对翻译有影响吗？**

A:

- ❌ 不影响翻译速度
- ❌ 不影响 AI API 调用
- ✅ 只影响章节抓取速度

---

#### 技术说明

**请求队列机制**:

系统使用 Promise 并发控制来实现并发限制：

```javascript
// 伪代码示例
const concurrencyLimit = 3;
const chapters = [章节1, 章节2, ..., 章节N];

// 分组处理
for (let i = 0; i < chapters.length; i += concurrencyLimit) {
  const batch = chapters.slice(i, i + concurrencyLimit);
  await Promise.all(batch.map(chapter => fetchChapter(chapter)));
}
```

**错误处理**:

- 单个请求失败不会影响其他请求
- 失败的章节可以单独重试
- 系统会自动记录失败的章节

---

#### 故障排查

**问题 1: 所有请求都失败**

可能原因:

- ❌ 网络连接问题
- ❌ 网站服务器故障
- ❌ IP 被封禁
- ❌ 需要登录或验证

解决方案:

1. 检查网络连接
2. 尝试在浏览器中直接访问网站
3. 更换 IP 或使用代理
4. 检查是否需要登录（Cookie）

**问题 2: 部分请求失败**

可能原因:

- ❌ 并发数过高
- ❌ 网站有速率限制
- ❌ 某些章节不存在

解决方案:

1. 降低并发数
2. 查看失败的章节编号
3. 单独重试失败的章节
4. 检查章节是否真实存在

**问题 3: 请求成功但内容为空**

可能原因:

- ❌ 网站更改了页面结构
- ❌ 需要 JavaScript 渲染（SPA 网站）
- ❌ 内容被隐藏或需要权限

解决方案:

1. 检查网站页面结构是否变化
2. 尝试使用桌面版（支持 JavaScript 渲染）
3. 确认是否需要登录或会员权限

---

#### 性能提示

**优化抓取速度**:

1. **合理配置并发数**:
   - 根据网站特性调整
   - 不要盲目追求最高值

2. **使用快速代理**（浏览器版）:
   - 自建代理通常比公共代理快
   - 选择地理位置接近的代理服务器

3. **批量操作**:
   - 一次性抓取多个章节
   - 避免频繁开始/停止

4. **错误重试**:
   - 只重试失败的章节
   - 避免重新抓取已成功的章节

---

**提示**: 爬虫设置虽然简单，但选择合适的并发数对抓取成功率和速度至关重要。遵守网站规则，使用合理的并发数，是负责任的爬虫使用者应该做的。🤖

---

### 6️⃣ 💾 导入/导出

**用途**: 一键备份和恢复完整数据，实现跨设备迁移或团队协作。

**核心特性**:

- 💾 **完整备份**: 导出所有数据到单个 JSON 文件
- 🔄 **完全恢复**: 从备份文件恢复所有数据
- 📦 **离线传输**: 无需网络，可通过 U 盘或邮件传输
- 🔐 **本地处理**: 所有操作均在本地进行，不经过服务器

---

#### 导出资料 📤

**功能**: 将当前所有数据导出为 JSON 文件

##### 导出内容

系统会导出以下所有数据：

**1. AI 模型配置**

- 所有已配置的 AI 模型
- 模型参数（温度、最大 tokens 等）
- 默认任务设置
- ⚠️ **包含 API Keys**

**2. 书籍数据**（每本书完整数据）

- 书籍元数据（标题、作者、简介、封面 URL 等）
- 完整章节列表
- 所有章节的原文和所有译文版本
- 段落级翻译数据
- 术语表
- 角色设定

**3. 记忆（Memories）**

- 所有书籍的 AI 记忆数据
- 记忆内容和摘要
- 关联信息

**4. 封面历史**

- 历史封面记录
- 封面 URL 和元数据

**5. 同步设置**

- Gist 同步配置（不含 Token）
- 同步历史记录

**6. 应用设置**

- 爬虫并发数限制
- 代理配置
- Tavily API Key
- 其他用户偏好

##### 导出步骤

1. 打开 **设置** → **导入/导出** 页面
2. 点击 **导出资料** 按钮
3. 等待系统收集所有数据（可能需要几秒到几分钟，取决于数据量）
4. 浏览器会自动下载文件

**文件名格式**: `tsukuyomi-settings-{timestamp}.json`

- 示例: `tsukuyomi-settings-2026-02-03T19-30-00.json`

##### 文件格式

导出的 JSON 文件结构：

```json
{
  "aiModels": [...],        // AI 模型配置
  "novels": [...],          // 书籍数据（含章节内容）
  "memories": [...],        // AI 记忆
  "coverHistory": [...],    // 封面历史
  "sync": [...],            // 同步设置
  "appSettings": {...}      // 应用设置
}
```

**文件大小**:

- 单本小说：通常 500KB - 5MB
- 多本小说：可能超过 50MB
- 章节越多、译文版本越多，文件越大

##### 导出文件的用途

1. **本地备份**: 保存到电脑、U 盘或云盘
2. **跨设备迁移**: 在不同设备间传输数据
3. **团队协作**: 分享翻译项目给团队成员
4. **版本控制**: 保留不同时期的备份，方便回溯

---

#### 导入资料 📥

**功能**: 从 JSON 文件恢复数据

⚠️ **重要警告**: 导入会 **完全覆盖** 当前所有数据！

##### 导入步骤

1. 打开 **设置** → **导入/导出** 页面
2. 点击 **导入资料** 按钮
3. 选择之前导出的 JSON 文件（或从其他地方获得的备份文件）
4. 等待系统处理（可能需要几秒到几分钟）
5. 看到成功提示后，刷新页面查看导入的数据

##### 导入行为

**完全覆盖模式**:

系统会按以下顺序覆盖数据：

1. **清空现有书籍**: 删除所有本地书籍数据
2. **导入书籍**: 添加文件中的所有书籍
3. **覆盖 AI 模型**: 覆盖 AI 模型配置（保留已有的 + 添加新的）
4. **清空并导入封面历史**: 完全替换封面历史
5. **导入记忆**: 为每本书重新创建 AI 记忆
6. **覆盖应用设置**: 应用文件中的设置
7. **覆盖同步设置**: 应用文件中的同步配置

**注意**:

- ❌ 不支持选择性导入（无法只导入部分数据）
- ❌ 不支持合并模式（新旧数据不会合并）
- ✅ 完全替换，确保数据一致性

##### 支持的文件格式

- **JSON 文件** (`.json`): Tsukuyomi 导出的标准格式
- **TXT 文件** (`.txt`): 包含 JSON 内容的文本文件

##### 导入后的检查

导入完成后，建议检查：

1. ✅ 书籍列表是否完整
2. ✅ AI 模型配置是否正确
3. ✅ 章节内容和翻译是否完整
4. ✅ 术语表和角色设定是否保留
5. ✅ 应用设置是否符合预期

---

#### 使用场景

##### 场景 1: 数据备份

**目的**: 防止数据丢失

**操作**:

1. 每周或完成重要翻译后导出一次
2. 保存到多个位置（本地 + 云盘）
3. 保留近期的多个版本

**最佳实践**:

```
备份策略：
- 每周备份: tsukuyomi-settings-weekly-20260203.json
- 重要项目完成后: tsukuyomi-settings-project-completed.json
- 保留最近 3-5 个备份
```

##### 场景 2: 设备迁移

**目的**: 从旧设备迁移到新设备

**操作**:

1. 在旧设备上导出所有数据
2. 将文件传输到新设备（U 盘、邮件、网盘等）
3. 在新设备上导入文件
4. 验证数据完整性

**注意**:

- ⚠️ 新设备上的现有数据会被覆盖
- ✅ 建议在全新安装上进行导入

##### 场景 3: 团队协作

**目的**: 与团队成员共享翻译项目

**操作**:

1. **分享者**: 导出包含翻译项目的数据
2. 通过安全渠道发送给团队成员（加密邮件、私有云盘等）
3. **接收者**: 导入文件获得完整项目数据

**协作建议**:

- 🔐 使用加密传输（文件可能含 API Keys）
- 📝 沟通清楚谁负责哪些章节
- ⏰ 定期同步进度（重新导出/导入）

##### 场景 4: 版本回退

**目的**: 恢复到之前的状态

**操作**:

1. 发现数据出现问题（如误删、翻译不满意）
2. 找到之前的备份文件
3. 导入该备份文件恢复到之前的状态

**回退策略**:

- 保留每次重要更改前的备份
- 使用清晰的文件名标记版本

---

#### 安全建议 🔒

##### 1. 保护导出文件

**风险**: 导出文件包含敏感信息

敏感数据包括：

- ⚠️ AI 服务商的 API Keys
- ⚠️ Tavily API Key
- ⚠️ GitHub Token（同步设置中，如果导出时包含）
- ℹ️ 翻译内容（可能有版权）

**保护措施**:

1. **加密存储**:
   - 使用 7-Zip、WinRAR 等工具加密压缩
   - 或使用操作系统的文件加密功能

2. **安全传输**:
   - 不要通过公开渠道分享
   - 使用私有云盘或加密邮件
   - 传输后删除原始文件

3. **定期清理**:
   - 删除过期的旧备份
   - 不要在公共电脑上留下备份

##### 2. 导入前备份

**最佳实践**: 导入前先导出当前数据

```
步骤：
1. 导出当前数据 → tsukuyomi-settings-before-import.json
2. 导入新数据
3. 如果出现问题，可恢复到 before-import 版本
```

##### 3. 验证文件来源

**警告**: 仅导入来自可信来源的文件

**风险**:

- 恶意文件可能包含有害内容
- 可能覆盖您的重要数据
- 可能泄露您的 API Keys

**验证方法**:

1. 确认文件来源（谁提供的、从哪里下载）
2. 使用文本编辑器打开检查内容
3. 在测试环境中先尝试导入

---

#### 与 GitHub Gist 同步的区别

| 特性           | 导入/导出            | GitHub Gist 同步     |
| -------------- | -------------------- | -------------------- |
| **操作方式**   | 手动                 | 手动 + 自动          |
| **数据传输**   | 本地文件             | 云端 Gist            |
| **版本历史**   | 需手动管理           | 自动保存修订历史     |
| **多设备同步** | 需手动传输文件       | 自动拉取/推送        |
| **网络要求**   | 无                   | 需要网络             |
| **容量限制**   | 无                   | Gist 单文件 10MB     |
| **适用场景**   | 离线备份、一次性迁移 | 多设备协作、持续备份 |

**推荐搭配使用**:

- 💻 多设备协作：主要使用 GitHub Gist 同步
- 💾 定期备份：每周手动导出一次离线备份
- 🔄 设备迁移：导出/导入传输完整数据
- 🛡️ 安全保障：导出文件作为 Gist 之外的备份

---

#### 常见问题

**Q: 导出的文件可以手动编辑吗？**

A:

- ✅ 可以，JSON 文件是纯文本
- ⚠️ 但不建议，容易损坏数据结构
- 🔧 如果必须编辑，建议使用专业的 JSON 编辑器

**Q: 导入失败怎么办？**

A:
可能原因：

1. 文件格式不正确（不是有效的 JSON）
2. 文件损坏（下载不完整、编辑错误）
3. 版本不兼容（旧版本导出的文件）

解决方案：

1. 检查文件是否完整
2. 使用 JSON 验证工具检查格式
3. 尝试其他备份文件
4. 查看浏览器控制台的错误信息

**Q: 导入后旧数据还能恢复吗？**

A:

- ❌ 导入会完全覆盖旧数据，无法自动恢复
- ✅ 如果导入前导出了备份，可以再次导入该备份恢复
- 💡 这就是为什么强烈建议"导入前先导出"

**Q: 可以只导入某些数据（如只导入书籍）吗？**

A:

- ❌ 目前不支持选择性导入
- 导入会处理文件中的所有数据
- 如果只想导入部分数据，需要手动编辑 JSON 文件删除不需要的部分

**Q: 导入会导入 GitHub Token 吗？**

A:

- ❌ 不会，GitHub Token 是加密存储的，不会被导出
- ✅ Gist 同步配置（用户名、Gist ID 等）会被导入
- ⚠️ 但 API Keys（OpenAI、Claude 等）会被导入

**Q: 文件太大怎么办？**

A:

- 如果文件超过 100MB，可能导出/导入较慢
- 解决方案：
  1. 删除不需要的旧书籍后再导出
  2. 分多次导出（但目前不支持，需等待功能更新）
  3. 使用压缩工具压缩后传输

---

#### 技术细节

##### 导出流程

```javascript
1. 收集所有书籍的章节内容
2. 加载所有书籍的 AI 记忆
3. 获取 AI 模型配置
4. 获取封面历史
5. 获取同步设置
6. 获取应用设置
7. 组装成 JSON 对象
8. 触发浏览器下载
```

##### 导入流程

```javascript
1. 读取文件内容
2. 解析 JSON
3. 清空现有书籍数据
4. 批量导入书籍（含章节内容）
5. 批量导入 AI 模型
6. 清空并导入封面历史
7. 为每本书重建 AI 记忆
8. 应用应用设置
9. 应用同步设置
10. 完成并提示用户
```

##### 数据完整性

**导出时的保证**:

- ✅ 所有章节内容都会被加载和导出
- ✅ 所有翻译版本都会保留
- ✅ 段落级数据完整保留

**导入时的保证**:

- ✅ 按正确顺序导入，避免数据依赖问题
- ✅ 失败时不会部分导入（要么全成功，要么全失败）
- ✅ 自动重建索引和关联

---

#### 故障排查

**问题 1: 导出按钮无响应**

可能原因:

- 数据量太大，系统正在收集
- 浏览器内存不足
- JavaScript 错误

解决方案:

1. 等待更长时间（可能需要 1-2 分钟）
2. 关闭其他浏览器标签页释放内存
3. 查看浏览器控制台错误信息
4. 刷新页面重试

**问题 2: 导出的文件很小（几 KB）**

可能原因:

- 数据库中没有数据
- 导出过程中出错

解决方案:

1. 检查是否有书籍数据
2. 查看控制台错误
3. 重新导出

**问题 3: 导入后部分数据丢失**

可能原因:

- 导出文件不完整
- 导入过程中断

解决方案:

1. 使用完整的备份文件重新导入
2. 检查文件大小是否异常
3. 验证 JSON 文件是否完整

**问题 4: 导入后 AI 模型无法使用**

可能原因:

- API Keys 未正确导入
- API Keys 已过期

解决方案:

1. 重新配置 API Keys
2. 在 AI 模型页面验证配置
3. 测试 API 连接

---

#### 最佳实践

##### 1. 定期导出备份

**推荐频率**:

- 📅 每周自动提醒自己导出一次
- 🎯 完成重要翻译后立即导出
- 🆕 添加新书后导出
- 🔧 修改重要配置后导出

**备份命名规范**:

```
tsukuyomi-{类型}-{日期}.json

示例:
tsukuyomi-weekly-20260203.json
tsukuyomi-project-completed-20260203.json
tsukuyomi-before-major-update-20260203.json
```

##### 2. 多地备份

**3-2-1 备份策略**:

- **3** 份拷贝：原始数据 + 2 份备份
- **2** 种介质：本地硬盘 + 云盘/U 盘
- **1** 份异地：云盘或远程位置

**示例**:

```
备份位置 1: 本地电脑 ~/Documents/Backups/
备份位置 2: Google Drive / OneDrive
备份位置 3: U 盘（定期更新）
```

##### 3. 版本管理

**保留多个版本**:

- 最近 7 天的每日备份
- 最近 4 周的每周备份
- 重要里程碑的永久备份

**自动清理策略**:

- 定期删除过期的日备份
- 保留重要的里程碑版本

##### 4. 测试恢复

**定期测试**:

- 每月测试一次导入流程
- 在新设备或浏览器中尝试导入
- 确保备份文件有效

**测试步骤**:

1. 导出当前数据（作为还原点）
2. 导入旧的备份文件
3. 检查数据完整性
4. 导入还原点恢复

---

**提示**: 导入/导出是 Tsukuyomi 最简单但最重要的功能之一。养成定期备份的习惯，可以有效防止数据丢失，确保您的翻译成果永久保存。备份永远不嫌多！💾

---

## 💡 最佳实践

### 1. 定期备份设置

建议每周或完成重要翻译项目后，使用 **导入/导出** 功能备份您的数据：

- ✅ 导出所有数据到安全的位置（如云盘、外部硬盘）
- ✅ 保留多个版本的备份（如每周一个）
- ✅ 定期验证备份文件的完整性

### 2. 优化 AI 模型配置

根据任务类型和预算，合理配置默认模型：

- **成本敏感**: 使用 Gemini 2.0 Flash 或 DeepSeek-V3 作为主力模型
- **质量优先**: 使用 GPT-o1 或 Claude 4 Opus 处理重要翻译
- **混合策略**: 初稿使用快速模型，精修使用高质量模型

### 3. 网络优化

如果遇到网络连接问题：

1. **检查代理设置**: 确保代理配置正确（浏览器版本）
2. **更换 API 服务商**: 尝试使用国内服务商（如 DeepSeek、Kimi）
3. **调整请求间隔**: 在爬虫设置中增加请求延迟

### 4. 数据安全

保护您的敏感信息：

- **API Keys**: 定期更换，不要分享给他人
- **导出文件**: 使用密码保护或加密存储
- **同步数据**: 仅使用可信的同步服务器

---

## ❓ 常见问题

**Q: 设置会自动保存吗？**
A: 是的，所有设置都会在您修改后自动保存到本地。无需手动点击保存按钮。

**Q: 如何重置所有设置？**
A: 目前没有一键重置功能，但您可以：1) 手动恢复默认值；2) 导入一个干净的设置文件；3) 重新安装应用（会清除所有本地数据）。

**Q: 浏览器版本和桌面版的设置有什么区别？**
A: 主要区别在于：1) 浏览器版本有 **代理设置** 选项卡；2) 桌面版会自动使用系统代理配置。

**Q: 导出的数据包含 API Keys 吗？**
A: 是的，导出的完整数据包含 API Keys。请妥善保管导出的文件，不要上传到公开位置。

**Q: 同步功能是否免费？**
A: 这取决于您选择的同步服务器。官方提供的同步服务可能有免费配额限制，自建服务器没有限制。

**Q: 爬虫设置中的 Cookie 如何获取？**
A: 您可以使用浏览器的开发者工具（F12）→ Network 选项卡 → 复制请求头中的 Cookie 值。或者使用浏览器扩展（如 EditThisCookie）导出。

**Q: 可以为不同的书籍使用不同的默认模型吗？**
A: 目前默认模型是全局设置。但在执行翻译任务时，您可以手动选择特定的模型，该选择会记录在书籍的设置中。

---

## ⚠️ 注意事项

1. **API 配额管理**: 使用 AI 服务会消耗 API 配额，请定期检查余额
2. **网络限制**: 某些设置（如同步、爬虫）需要稳定的网络连接
3. **数据容量**: 导入数据前，确保本地存储有足够的空间
4. **版本兼容**: 导入数据时，注意文件的版本是否与当前应用兼容

---

## 🤝 反馈与建议

在使用设置功能过程中有任何想法？欢迎：

- 在 GitHub 提交 [Issue](https://github.com/rozx/luna-ai-translator/issues)
- 加入我们的讨论社区分享心得
- 通过聊天助手告诉我们您的建议

---

> **小贴士**
>
> 设置是 Tsukuyomi 最强大的功能之一。花一些时间了解和优化您的配置，可以显著提升翻译效率和质量。记得定期备份您的数据！
