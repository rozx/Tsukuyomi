# 发布说明 - v0.8.1

## 版本信息
- **版本号**: 0.8.1
- **发布日期**: 2025年12月27日

---

## 🎉 新功能

### 1. 项目品牌重塑
- **项目重命名**：
  - 项目从 "Luna AI Translator" 重命名为 "Tsukuyomi - Moonlit Translator"（月咏 - 月光翻译器）
  - 更新所有文档、代码注释和用户界面中的项目名称
  - 更新 README 文件，包含日文项目名称
  - 统一品牌标识，提升项目识别度
- **主题迁移**：
  - 从 Luna 主题迁移到 Tsukuyomi 主题
  - 更新图标和品牌资产（favicon、应用图标等）
  - 优化应用品牌和 UI 一致性

### 2. 书籍上下文构建功能
- **书籍信息集成**：
  - 新增 `buildBookContextSection` 函数，为 AI 任务提供书籍上下文信息
  - 自动提取书籍的书名、简介和标签信息
  - 在翻译、润色、校对等 AI 任务中自动包含书籍上下文
  - 帮助 AI 模型统一翻译风格和用词，提升翻译一致性
- **上下文优化**：
  - 支持从 Store 或 IndexedDB 获取书籍信息
  - 自动截断过长的简介（超过 600 字符），避免提示词过长
  - 为空值情况提供优雅降级处理

### 3. 章节标题规范化功能
- **标题格式统一**：
  - 新增 `normalizeChapterTitle` 函数，自动规范化章节标题格式
  - 支持将章节标题中的半角空格转换为全角空格（如 "第110话 测试" → "第110话　测试"）
  - 支持多种章节标题格式（"第X话"、"X话"、"第X话"等）
  - 提供章节级别的开关选项（`normalizeTitleOnDisplay`），支持按章节启用/禁用
- **显示优化**：
  - 在章节设置面板中提供标题规范化开关
  - 支持书籍级别的默认设置，章节可单独覆盖
  - 优化章节标题的显示一致性

### 4. 段落追踪增强
- **进度追踪优化**：
  - 增强 AI 任务处理中的段落追踪功能
  - 在进度回调中包含当前处理的段落 ID 列表（`currentParagraphs`）
  - 提供更详细的翻译进度信息，用户可以了解当前正在处理哪些段落
  - 支持翻译、润色、校对等所有 AI 任务的段落追踪

### 5. 工具使用限制机制
- **严格工具范围控制**：
  - 新增 `getToolScopeRules` 函数，严格限制 AI 只能调用本次请求提供的工具
  - 在 `executeToolCallLoop` 中实现工具调用验证，拒绝未授权的工具调用
  - 在 `AssistantService` 中实现工具调用限制检查
  - 防止 AI 调用未提供的工具，提升安全性和可控性
- **工具调用限制配置**：
  - 为不同工具设置调用次数限制（如 `list_terms` 最多 3 次，`list_characters` 最多 3 次）
  - 提供清晰的错误提示，告知 AI 工具调用限制
  - 优化工具调用策略，避免无效的工具调用循环

### 6. 记忆工作流规则
- **记忆管理规范**：
  - 新增 `getMemoryWorkflowRules` 函数，提供清晰的记忆管理规则
  - 明确记忆创建条件：只在对未来翻译任务有长期收益、可跨段落/跨章节复用时创建
  - 区分适合写入记忆的内容（稳定的敬语/称谓处理规则、固定译法选择等）和禁止写入的内容（一次性句子翻译、临时推断等）
  - 提供记忆搜索和更新的最佳实践指导
- **测试覆盖**：
  - 新增记忆工作流规则测试，确保规则的正确性和完整性

### 7. 章节翻译更新功能
- **目标章节处理**：
  - 实现章节翻译更新功能，支持目标章节处理
  - 优化章节翻译的更新逻辑，确保翻译内容正确关联到目标章节
  - 改进章节翻译的创建和更新流程

### 8. 段落翻译功能增强
- **小说引用支持**：
  - 增强段落翻译功能，支持小说引用
  - 优化段落翻译的创建和更新逻辑
  - 改进段落翻译与书籍上下文的关联

### 9. CORS 代理支持
- **图片上传优化**：
  - 在封面服务和图片上传服务中集成 CORS 代理支持
  - 支持通过 CORS 代理访问外部图片资源
  - 优化 SPA 构建中的图片上传和封面设置流程
  - 提升跨域资源访问的可靠性

### 10. 设置导入/导出功能改进
- **同步处理优化**：
  - 改进设置导入/导出功能和同步处理逻辑
  - 优化设置数据的验证和转换机制
  - 增强设置同步的稳定性和准确性
  - 改进设置冲突检测和解决策略

---

## 🔧 改进与优化

### AI 任务处理优化
- **文本显示增强**：
  - 增强 `ThinkingProcessPanel` 和 `AppRightPanel` 中的文本显示功能
  - 优化 AI 思考过程和输出内容的展示方式
  - 改进文本格式化和渲染逻辑
- **段落追踪**：
  - 在翻译、润色、校对等 AI 任务中增强段落追踪功能
  - 提供更详细的进度信息，包括当前处理的段落 ID
  - 优化进度回调机制，提升用户体验

### 服务代码优化
- **图片上传服务**：
  - 简化 `ImageUploadService` 中的 `BASE_API_URL` 处理逻辑
  - 优化 CORS 代理的使用方式
  - 改进错误处理和日志记录
- **封面服务**：
  - 改进十六进制颜色验证逻辑
  - 优化颜色格式检查和转换
  - 增强错误提示的清晰度

### 本地存储优化
- **迁移逻辑增强**：
  - 增强 toast 历史和最后查看记录的本地存储迁移逻辑
  - 优化存储键名的迁移策略
  - 改进数据迁移的兼容性和可靠性
  - 支持从旧版本平滑升级到新版本

### UI 和用户体验优化
- **品牌一致性**：
  - 统一应用品牌标识和 UI 风格
  - 更新所有图标和品牌资产
  - 优化应用名称和描述的显示
- **章节设置**：
  - 在章节设置面板中新增标题规范化开关
  - 优化章节设置的交互体验
  - 改进设置选项的可见性和可访问性

---

## 🐛 问题修复

### 封面服务修复
- **颜色验证改进**：
  - 修复十六进制颜色验证逻辑中的边界情况处理
  - 改进颜色格式验证的准确性
  - 优化错误提示信息

### 本地存储迁移修复
- **迁移键名更新**：
  - 修复本地存储迁移逻辑中的键名问题
  - 确保 toast 历史和最后查看记录的迁移正确执行
  - 改进数据迁移的错误处理

---

## 📝 技术细节

### 主要修改文件
- `src/services/ai/tasks/utils/ai-task-helper.ts`：新增 `buildBookContextSection` 函数，增强段落追踪功能（+150 行，-部分代码）
- `src/services/ai/tasks/translation-service.ts`：集成书籍上下文构建功能（+20 行，-部分代码）
- `src/services/ai/tasks/proofreading-service.ts`：集成书籍上下文构建功能（+15 行，-部分代码）
- `src/services/ai/tasks/polish-service.ts`：集成书籍上下文构建功能（+15 行，-部分代码）
- `src/services/ai/tasks/term-translation-service.ts`：集成书籍上下文构建功能（+10 行，-部分代码）
- `src/services/ai/tasks/prompts/index.ts`：新增 `getToolScopeRules` 和 `getMemoryWorkflowRules` 函数（+50 行）
- `src/services/ai/tasks/utils/ai-task-helper.ts`：实现工具调用限制机制（+80 行，-部分代码）
- `src/services/ai/tasks/assistant-service.ts`：实现工具调用限制检查（+30 行，-部分代码）
- `src/utils/novel-utils.ts`：新增 `normalizeChapterTitle` 函数（+80 行）
- `src/models/novel.ts`：新增 `normalizeTitleOnDisplay` 字段（+2 行）
- `src/components/novel/ChapterSettingsPopover.vue`：新增标题规范化开关（+30 行，-部分代码）
- `src/services/image-upload-service.ts`：集成 CORS 代理支持（+20 行，-部分代码）
- `src/services/cover-service.ts`：改进颜色验证逻辑（+15 行，-部分代码）
- `src/__tests__/novel-utils.test.ts`：新增标题规范化测试（+150 行）
- `src/__tests__/memory-workflow-rules.test.ts`：新增记忆工作流规则测试（+12 行）
- `src/__tests__/ai-task-helper.book-context.test.ts`：新增书籍上下文构建测试（+100 行）
- `README.md`：更新项目名称和描述（+5 行，-部分代码）
- `package.json`：版本号更新至 0.8.1（+2 行，-1 行）
- `src/constants/version.ts`：版本号更新至 0.8.1（+2 行，-1 行）

### 新增功能统计
- **新增功能**: 10 项
- **改进优化**: 4 项
- **问题修复**: 2 项
- **代码变更**: 约 800 行新增，200 行删除
- **修改文件**: 25 个文件

---

## 🎯 用户体验改进

1. **品牌识别度提升**：项目重命名为 Tsukuyomi，统一品牌标识，提升项目识别度和专业性
2. **翻译一致性增强**：书籍上下文构建功能帮助 AI 模型统一翻译风格和用词，显著提升翻译一致性
3. **标题显示优化**：章节标题规范化功能确保标题格式统一，提升阅读体验
4. **进度追踪透明化**：段落追踪功能提供更详细的翻译进度信息，用户可以清楚了解当前处理状态
5. **工具调用安全性**：工具使用限制机制防止 AI 调用未授权的工具，提升系统安全性和可控性
6. **记忆管理规范化**：记忆工作流规则提供清晰的记忆管理指导，避免创建不必要的记忆
7. **图片上传可靠性**：CORS 代理支持提升跨域资源访问的可靠性，改善图片上传体验
8. **设置同步稳定性**：改进的设置导入/导出功能提升设置同步的稳定性和准确性

---

## 🔄 升级建议

本次更新主要聚焦于：

1. **品牌重塑**：项目重命名为 Tsukuyomi，所有用户都将看到新的品牌标识和名称
2. **翻译质量提升**：书籍上下文构建功能显著提升翻译一致性，特别适合处理系列小说的用户
3. **标题格式统一**：章节标题规范化功能确保标题显示一致，特别适合需要统一格式的用户
4. **安全性增强**：工具使用限制机制提升系统安全性，所有用户都将受益
5. **记忆管理优化**：记忆工作流规则帮助用户更好地管理记忆，避免创建不必要的记忆
6. **图片上传改进**：CORS 代理支持改善图片上传体验，特别适合需要上传外部图片的用户

建议所有用户升级以获得更好的使用体验。特别是对于需要处理系列小说或需要统一翻译风格的用户，本次更新将显著提升使用体验。

---

## 📚 相关文档

- 项目架构文档：`AGENTS.md`
- 翻译指南：`docs/TRANSLATION_GUIDE.md`
- 主题指南：`docs/THEME_GUIDE.md`
- 批量替换示例：`docs/batch-replace-examples.md`
- AI 任务流程文档：`docs/TRANSLATION_AI_TASK_FLOW.md`
- 流程改进建议：`docs/TRANSLATION_AI_TASK_FLOW_IMPROVEMENTS.md`

---

## 🙏 致谢

感谢所有为本次版本做出贡献的开发者。

---

*本文档由自动化工具生成，如有疑问请提交 Issue。*

