## Context

当前系统为桌面优先架构：`MainLayout` 采用左侧导航 + 中央主内容 + 右侧助手三栏结构，`BookDetailsPage` 将目录、正文、设置面板、翻译进度等高密度功能聚合在同一工作区。现有交互广泛依赖固定宽度弹层、Popover 锚点和鼠标操作（如拖拽排序、面板拉伸），在手机与平板下会出现可达性与可操作性问题。

本变更的硬约束是“功能不删减”：手机与平板必须保留桌面全部能力，仅允许在信息架构与交互路径上重排。后端 API、数据模型、存储结构不变，主要改动集中在前端布局层、工作区编排层、弹层系统和触控交互层。

## Goals / Non-Goals

**Goals:**
- 在手机、平板、桌面三类断点下提供一致的功能覆盖，保证所有核心与高级能力可达。
- 建立统一的响应式壳层和弹层策略，避免页面级临时补丁导致行为碎片化。
- 在不破坏现有数据与业务流程的前提下，逐步迁移高风险页面（优先 `BookDetails`）。
- 为鼠标导向能力提供触控等价路径，确保移动设备可完成完整工作流。

**Non-Goals:**
- 不进行品牌视觉重设计，不改变主题体系与文案风格。
- 不引入后端接口改造，不修改 IndexedDB 结构。
- 不减少任何现有功能，不通过“移动端阉割”降低复杂度。
- 不在本阶段优化与本变更无关的 AI 业务逻辑或翻译质量策略。

## Decisions

### 决策 1：建立全局断点契约与壳层自适应
- 选择：
  - `Phone <= 767`
  - `Tablet 768 - 1279`
  - `Desktop >= 1280`
  - 壳层在运行时依据断点切换布局语义（非仅 CSS 压缩）。
- 理由：
  - 现有壳层是固定三栏语义，单纯样式收缩无法保证入口可达与触控可用。
  - 统一断点契约可避免各页面各自定义“移动态”造成行为不一致。
- 备选方案与结论：
  - 方案 A：纯 CSS 响应式压缩现有三栏。缺点是交互语义不变，移动端仍拥挤，否决。
  - 方案 B：新增独立移动路由与页面。缺点是双份维护成本高，状态同步复杂，否决。
  - 方案 C：同一路由下自适应壳层（采用）。在一致状态模型下重排 UI，维护成本最低。

### 决策 2：`BookDetails` 采用“单工作区多模式”而非“固定双栏”
- 选择：
  - 手机：单主视图模式切换（内容/目录/设置/进度），通过显式模式入口切换。
  - 平板：左栏可折叠 + 主区复合模式（必要时滑出助手或进度区）。
  - 保留现有关键状态（`selectedChapter`、`selectedSettingMenu`、`showTranslationProgress`），新增视图模式状态承载断点编排。
- 理由：
  - `BookDetails` 是功能最密集页面，需要在小屏幕上将并行面板改为可导航工作区，才能全功能保留。
  - 复用既有业务状态可降低回归风险，避免重写核心逻辑。
- 备选方案与结论：
  - 方案 A：拆分为多个路由页面（目录页/正文页/设置页）。优点清晰，缺点状态切换成本高且打断流程，否决。
  - 方案 B：同页面内模式切换（采用）。能保留上下文连续性与现有状态管理。

### 决策 3：弹层系统统一为“断点感知 Overlay 策略”
- 选择：
  - 统一定义 Dialog/Popover 在不同断点的展示规则：
    - Phone：优先全屏 Dialog 或底部面板；
    - Tablet：中宽弹层；
    - Desktop：维持当前桌面弹层行为。
  - Popover 在手机端降级为可滚动面板/底部面板，避免锚点依赖。
- 理由：
  - 当前大量固定宽度弹层分散在各组件，单点修复不可持续。
  - 统一策略可作为后续页面迁移的可复用基础设施。
- 备选方案与结论：
  - 方案 A：逐组件手动改宽度。短期可行但长期不可维护，否决。
  - 方案 B：建立统一 Overlay 适配层（采用），一次定义、全局复用。

### 决策 4：为鼠标专属交互提供触控等价路径
- 选择：
  - 章节排序在触控端提供显式排序动作（上移/下移/移入卷）作为拖拽替代；
  - 面板拉伸在触控端改为预设宽度或模式切换，不依赖鼠标拖拽手柄；
  - 将键盘快捷能力映射到“更多操作”可见入口，确保移动端可达。
- 理由：
  - 功能保留不仅是“组件存在”，还必须保证在触控设备上可操作。
- 备选方案与结论：
  - 方案 A：保留拖拽并尝试移动端兼容。实现复杂且稳定性差，否决。
  - 方案 B：提供等价显式操作（采用），可预测、可测试、学习成本可控。

### 决策 5：采用分阶段迁移与回归验证
- 选择：
  - 阶段化实施：壳层 -> `BookDetails` -> 弹层体系 -> 次级页面。
  - 每阶段引入多断点回归用例，覆盖手机竖屏、平板竖/横屏、桌面。
- 理由：
  - 该变更跨模块范围大，分阶段可控制回归面并快速定位问题。
- 备选方案与结论：
  - 方案 A：一次性全量改造。风险与回滚成本过高，否决。
  - 方案 B：分阶段推进（采用），可控性更高。

## Risks / Trade-offs

- [风险] `BookDetails` 交互重排后，老用户操作路径变化导致学习成本上升  
  -> 缓解：提供清晰的模式入口命名与首次引导，保留关键快捷操作的“更多操作”映射。

- [风险] 断点切换引入状态同步问题（同一功能在不同布局下显示不一致）  
  -> 缓解：以现有 store 状态为单一事实来源，新增视图状态最小化并定义切换规则。

- [风险] 统一弹层策略可能影响现有大量 Dialog/Popover 的细节行为  
  -> 缓解：先定义基线规则并分批迁移，关键弹层（设置、抓取、书籍编辑）优先验证。

- [风险] 触控等价操作替代拖拽后，效率可能低于桌面  
  -> 缓解：在平板保留可选拖拽路径，在手机提供批量与快捷移动操作减少操作次数。

- [风险] 回归范围大，测试成本显著上升  
  -> 缓解：建立断点分层测试矩阵，优先保障高频主路径（选章、翻译、进度、设置）。

## Migration Plan

1. 建立断点契约与响应式壳层基础能力（不改业务逻辑）。  
2. 迁移 `BookDetails` 为断点感知工作区模式，保持现有状态字段语义。  
3. 引入统一 Overlay 适配规则，改造高优先级弹层（设置、抓取、书籍/AI 编辑）。  
4. 迁移 `BooksPage`、`AIPage`、`HelpPage` 的小屏编排与入口可达性。  
5. 补充多断点回归测试与手工验收脚本，覆盖手机/平板/桌面主流程。  

回滚策略：
- 以提交粒度按阶段回滚（壳层、工作区、弹层、页面适配分离），确保可快速恢复上个稳定阶段。
- 不涉及数据迁移，回滚无需数据修复。

## Open Questions

- 手机端章节排序的默认交互是否优先“动作菜单”还是“长按排序模式”？  
- 平板横屏是否默认展示助手面板，还是按用户上次状态恢复？  
- `HelpPage` 在平板下采用双栏还是可切换目录抽屉，哪种更符合阅读效率？  
- 是否需要在设置中提供“强制桌面布局”开关用于特定大屏设备偏好？
