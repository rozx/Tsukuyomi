# Design: Add Help Docs AI Tool

## Context

**当前状态**：
- 聊天助手服务（`assistant-service.ts`）目前提供多种AI工具，包括术语管理、角色设定、记忆管理等
- 帮助文档位于 `public/help/` 目录，包含多个Markdown文件和索引文件 `index.json`
- AI工具系统采用Function Calling机制，通过 `ToolRegistry` 管理所有可用工具
- 现有工具示例：`web-search-tools.ts` 提供网络搜索能力，使用Tavily API

**约束**：
- 帮助文档是静态文件，存储在 `public/help/` 目录
- 需要通过HTTP请求获取文档内容
- 工具必须返回JSON格式的结果
- 工具需要遵循现有的 `ToolDefinition` 接口
- 工具应该在聊天助手中可用，但不需要bookId（全局工具）

**利益相关者**：
- 用户：希望通过聊天助手获取准确的使用指导
- 开发者：需要易于维护和扩展的工具系统

## Goals / Non-Goals

**Goals:**
- 为聊天助手添加帮助文档查询能力
- 提供搜索、获取和列表三种查询方式
- 利用现有的 `public/help/index.json` 作为索引
- 保持与现有工具系统的一致性
- 提供清晰的错误处理和用户反馈

**Non-Goals:**
- 不修改帮助文档的内容或结构
- 不实现文档的编辑或更新功能
- 不提供文档的版本管理
- 不实现复杂的语义搜索（仅基于关键词匹配）

## Decisions

### 1. 工具设计

**决策**：创建三个独立的工具函数
- `search_help_docs`: 根据关键词搜索帮助文档
- `get_help_doc`: 获取指定帮助文档的完整内容
- `list_help_docs`: 列出所有可用的帮助文档

**理由**：
- 分离关注点：每个工具专注于单一职责
- 灵活性：AI可以根据需要选择使用哪个工具
- 与现有工具模式一致：如 `web-search-tools.ts` 中的 `search_web` 和 `fetch_webpage`

**替代方案**：
- 只提供一个通用的 `query_help_docs` 工具，通过参数区分操作类型
  - 缺点：增加工具描述的复杂性，AI可能难以理解
  - 优点：减少工具数量

### 2. 文档内容获取方式

**决策**：通过HTTP请求获取帮助文档内容

**实现细节**：
- 使用 `axios` 发送GET请求到 `/help/{file}` 路径
- 文档路径从 `index.json` 中获取
- 返回文档的完整Markdown内容

**理由**：
- 简单直接：不需要额外的服务层
- 与现有模式一致：`web-search-tools.ts` 也使用axios
- 利用Vite的静态文件服务

**替代方案**：
- 在构建时将所有文档打包到JavaScript中
  - 缺点：增加bundle大小，文档更新需要重新构建
  - 优点：无需HTTP请求，性能更好

### 3. 搜索实现

**决策**：基于关键词的简单文本搜索

**实现细节**：
- 在 `index.json` 的 `title`、`description` 字段中搜索关键词
- 支持模糊匹配（包含关键词即可）
- 返回匹配的文档列表，包含id、title、description、category

**理由**：
- 实现简单：无需复杂的搜索引擎
- 性能足够：文档数量不多（约20个）
- 可扩展：未来可以升级为更复杂的搜索

**替代方案**：
- 实现全文搜索（搜索Markdown文件内容）
  - 缺点：需要加载所有文档，性能开销大
  - 优点：搜索结果更准确

### 4. 工具注册

**决策**：在 `ToolRegistry` 中添加 `getHelpDocsTools()` 方法

**实现细节**：
- 新方法 `getHelpDocsTools()` 返回帮助文档工具数组
- 在 `getAllTools()` 中调用此方法，使工具在所有服务中可用
- 工具不需要bookId，因此始终可用

**理由**：
- 与现有模式一致：`getWebSearchTools()` 也是类似实现
- 灵活性：可以在不同服务中控制工具可用性
- 清晰的职责分离

**替代方案**：
- 直接在 `getAllTools()` 中内联工具定义
  - 缺点：代码组织不清晰，难以维护

### 5. 错误处理

**决策**：统一的错误处理模式

**实现细节**：
- 所有工具返回统一的JSON格式：`{ success: boolean, error?: string, data?: any }`
- 提供清晰的错误消息，指导用户解决问题
- 在控制台记录详细错误信息用于调试

**理由**：
- 与现有工具一致：`web-search-tools.ts` 使用相同的模式
- 便于AI理解和处理错误
- 提供良好的用户体验

## Risks / Trade-offs

### 风险1：帮助文档路径变更

**描述**：如果帮助文档的目录结构或文件名变更，工具可能失效

**缓解措施**：
- 使用 `index.json` 作为单一真实来源
- 添加路径验证和错误处理
- 在文档中明确说明工具依赖的文件结构

### 风险2：搜索结果不准确

**描述**：基于关键词的简单搜索可能无法满足所有查询需求

**缓解措施**：
- 在工具描述中明确说明搜索范围（title和description）
- 建议用户使用具体的关键词
- 未来可以升级为全文搜索

### 风险3：性能问题

**描述**：频繁的HTTP请求可能影响性能

**缓解措施**：
- 文档数量少，请求开销不大
- 考虑添加简单的缓存机制（可选）
- 优化搜索算法，避免不必要的请求

### 权衡：简单性 vs 功能性

**描述**：选择简单的实现可能限制未来扩展

**权衡**：
- 当前选择简单实现，快速上线
- 保留扩展空间，未来可以升级
- 避免过度设计

## Migration Plan

### 部署步骤

1. **创建工具文件**：`src/services/ai/tools/help-docs-tools.ts`
2. **更新ToolRegistry**：添加 `getHelpDocsTools()` 方法和工具注册
3. **更新聊天助手**：在 `assistant-service.ts` 中包含帮助文档工具
4. **测试**：验证工具在聊天助手中正常工作
5. **文档更新**：更新帮助文档，说明新功能

### 回滚策略

- 从 `ToolRegistry` 中移除 `getHelpDocsTools()` 调用
- 删除 `help-docs-tools.ts` 文件
- 从聊天助手的工具集中移除帮助文档工具

## Open Questions

1. 是否需要添加缓存机制来优化性能？
   - 当前不需要，但可以预留扩展空间

2. 是否需要支持多语言帮助文档？
   - 当前仅支持中文，未来可以扩展

3. 是否需要提供文档的版本信息？
   - 当前不需要，文档版本通过更新日志管理

4. 搜索是否应该区分大小写？
   - 当前不区分，提供更好的用户体验
