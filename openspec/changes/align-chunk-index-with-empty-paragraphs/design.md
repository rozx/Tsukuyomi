## Context

当前 AI 任务流水线存在两套并行的段落索引语义：

- chunk 展示侧：在 `buildFormattedChunks` 中先过滤空段落，再按 chunk 内顺序从 0 递增编号。
- 工具返回侧：`get_previous_paragraphs` / `get_next_paragraphs` / `get_paragraph_info` 返回章节原始 `paragraph_index`，该索引包含空段落。

这导致模型在同一会话中看到的编号不一致。虽然提交已强制使用 `paragraph_id`，但模型仍会用索引做定位与核对，进而出现“误以为工具返回的是别的段落”或重复请求上下文的问题。

约束条件：

- 不改变 `add_translation_batch` 的提交契约（继续仅允许 `paragraph_id`）。
- 不改变段落处理边界（空段落仍不进入待处理集合）。
- 变更应覆盖 translation/polish/proofreading 三条任务链路，并与现有 chunk boundary 机制兼容。

## Goals / Non-Goals

**Goals:**

- 统一模型可见索引语义：chunk 文本中的 `[index]` 与段落工具 `paragraph_index` 一致（均为章节原始索引，包含空段落计数）。
- 保持处理范围不变：空段落继续被过滤，避免引入空段落提交路径。
- 消除提示词歧义：所有任务提示统一表达“索引仅用于定位，提交必须使用 `paragraph_id`”。
- 提供可回归验证：确保“索引一致性”与“提交主键语义”同时成立。

**Non-Goals:**

- 不重构段落工具返回结构，不新增新的段落定位字段。
- 不将 UI 全部段落导航/显示逻辑改为“非空索引体系”。
- 不恢复任何 `index` 提交兼容路径。

## Decisions

### Decision 1: 采用“过滤空段落 + 原始索引展示”的混合策略

- 决策：chunk 构建继续过滤空段落作为待处理集合，但每条展示行的 `[index]` 使用该段落在章节内容中的原始位置索引。
- 原因：
  - 可直接与工具返回的 `paragraph_index` 对齐，降低模型认知负担。
  - 保持空段落不参与处理，不影响现有完成度校验和批量提交约束。
- 备选方案：
  - 方案 A（否决）：全量改工具与 UI 为“非空索引”体系。改动面大、回归成本高，且对提交契约收益有限。
  - 方案 B（否决）：保持现状，仅靠提示词解释两套索引。无法从根上消除模型误解。

### Decision 2: 明确“索引是辅助信息，paragraph_id 是主键”

- 决策：在 chunk 提示与执行提示中统一增加约束：索引只用于阅读定位，提交结果必须使用 `paragraph_id`。
- 原因：
  - 系统提交与边界校验已经围绕 `paragraph_id` 构建，索引不应参与状态机关键路径。
  - 可防止未来提示词回退到“index 或 paragraph_id 均可”的混合表达。
- 备选方案：
  - 方案 A（否决）：完全移除 chunk 中的索引展示。可行但会降低人工与模型的快速定位体验。

### Decision 3: 在任务链路统一做索引语义对齐测试

- 决策：增加覆盖 translation/polish/proofreading 的回归用例，重点验证：
  - chunk 内展示索引与工具 `paragraph_index` 对齐；
  - 空段落过滤仍生效；
  - `add_translation_batch` 仍仅接受 `paragraph_id`。
- 原因：
  - 该问题属于“提示 + 工具 +格式化”交叉行为，单点测试不足以防回归。
- 备选方案：
  - 方案 A（否决）：仅补一个格式化单测。无法覆盖提示词和工具协同语义。

## Risks / Trade-offs

- [Risk] 模型看到索引跳号（如 `[1]` 后直接 `[3]`）可能误判“漏段”。
  → Mitigation：在 chunk 说明中明确“空段落已过滤，索引按章节原始位置显示”。

- [Risk] 历史测试或文档默认 chunk 内连续编号，变更后可能失败。
  → Mitigation：同步更新相关测试断言与说明文档，统一语义词汇。

- [Risk] 多处提示词存在遗留文案，可能再次引入矛盾说明。
  → Mitigation：集中梳理 prompts 与 runner 提示片段，增加关键文案快照测试。

## Migration Plan

1. 先调整 chunk 格式化层，输出原始索引并保留现有段落 ID 标注。
2. 再统一任务提示词与运行时提醒文案，删除 `index` 提交暗示。
3. 补齐测试并执行回归，重点关注跨 chunk 上下文工具与批量提交流程。
4. 如发现模型行为异常，可临时回滚为旧展示索引策略（不涉及数据迁移）。

## Open Questions

- 是否需要在 chunk 中将索引显式标记为 `orig_index` 以进一步减少误解？
- 是否需要在工具响应里补充“当前 chunk 可见索引提示”字段，帮助模型对照？
- 后续是否将该规则沉淀到统一提示词组件，避免各任务重复维护文案？
