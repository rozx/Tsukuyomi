# 发布说明 - v0.7.9

## 版本信息
- **版本号**: 0.7.9
- **发布日期**: 2025年12月20日

---

## 🎉 新功能

### 1. AI 模型配置服务
- **ConfigService 新增**：
  - 新增 `ConfigService` 类，提供统一的 AI 模型配置管理功能
  - 支持从 AI 模型自动获取最大输入 token 数（maxInputTokens）和上下文窗口大小（contextWindow）
  - 提供配置获取提示词，要求 AI 以 JSON 格式返回配置信息
  - 支持配置验证和错误处理
  - 集成到 AI 模型对话框，实现自动配置获取

### 2. AI 模型对话框增强
- **上下文窗口验证和输入改进**：
  - 新增上下文窗口（contextWindow）字段支持
  - 支持从 AI 自动获取并填充上下文窗口大小
  - 改进表单验证逻辑，确保上下文窗口值大于 0
  - 优化输入字段显示，提供更清晰的提示信息
  - 自动更新模型配置信息，提升用户体验
- **配置自动获取**：
  - 测试模型时自动获取并显示 maxTokens 和 contextWindow
  - 自动填充表单字段，减少手动输入
  - 提供配置信息的详细反馈

### 3. 共享提示词模块
- **提示词结构优化**：
  - 新增 `src/services/ai/tasks/prompts/index.ts` 共享提示词模块
  - 精简和合并提示词，提高速度和效率
  - 统一管理格式规则、数据管理规则、记忆工作流等
  - 改进提示词的可维护性和复用性
- **提示词内容优化**：
  - 合并敬语/术语/角色工作流规则
  - 精简符号格式规则和数据管理规则
  - 优化待办事项工具描述和状态字段说明
  - 改进输出格式要求和执行工作流说明

### 4. 重试机制增强
- **润色和校对服务重试**：
  - 在 `PolishService` 和 `ProofreadingService` 中实现重试机制
  - 最大重试次数为 3 次，自动检测 AI 降级或错误
  - 重试时自动移除上次失败的消息，确保对话历史清洁
  - 提供重试状态反馈，提升用户体验
- **错误处理改进**：
  - 改进错误检测逻辑，准确识别需要重试的情况
  - 优化重试流程，确保数据一致性
  - 增强错误日志记录，便于问题追踪

---

## 🔧 改进与优化

### AI 任务辅助函数重构
- **代码结构简化**：
  - 重构 `ai-task-helper.ts`，消除重复代码
  - 改进工具调用循环的逻辑和性能
  - 优化函数组织和抽象层次
  - 重置连续状态计数，改进状态管理
- **AssistantService 优化**：
  - 简化并增强 AssistantService 的提示词结构
  - 改进系统提示词的构建逻辑
  - 优化上下文窗口处理，自动调整 maxTokens
  - 增强消息历史管理和总结触发机制

### 服务代码简化
- **翻译、润色、校对服务重构**：
  - 简化服务代码结构，移除重复逻辑
  - 统一使用共享的工具调用循环
  - 改进错误处理和验证逻辑
  - 提升代码复用性和可维护性
- **提示词统一管理**：
  - 将分散的提示词逻辑集中到共享模块
  - 改进提示词的一致性和准确性
  - 优化提示词的更新和维护流程

### 上下文窗口管理增强
- **AssistantService 上下文处理**：
  - 改进上下文窗口的计算和使用
  - 自动调整 maxTokens 以适应上下文窗口限制
  - 优化消息 token 估算，提升准确性
  - 增强总结触发机制，确保在上下文窗口不足时及时总结

---

## 🐛 问题修复

### 工具调用循环修复
- **状态计数重置**：
  - 修复工具调用循环中连续状态计数未重置的问题
  - 改进状态管理逻辑，确保每次循环的正确性
  - 优化状态转换和验证流程

### AI 任务提醒和输出格式修复
- **提示词更新**：
  - 更新 AI 任务提醒，确保与最新工作流一致
  - 修复输出格式说明，明确 JSON 格式要求
  - 改进状态字段描述，提升 AI 理解准确性

---

## 📝 技术细节

### 主要修改文件
- `src/services/ai/tasks/config-service.ts`：新增配置服务（+94 行）
- `src/services/ai/tasks/prompts/index.ts`：新增共享提示词模块（+139 行）
- `src/components/dialogs/AIModelDialog.vue`：增强 AI 模型对话框（+237 行，-部分代码）
- `src/services/ai/tasks/ai-task-helper.ts`：重构任务辅助函数（+586 行，-部分代码）
- `src/services/ai/tasks/assistant-service.ts`：简化并增强 AssistantService（+305 行，-部分代码）
- `src/services/ai/tasks/polish-service.ts`：实现重试机制，代码重构（+482 行，-部分代码）
- `src/services/ai/tasks/proofreading-service.ts`：实现重试机制，代码重构（+509 行，-部分代码）
- `src/services/ai/tasks/translation-service.ts`：代码重构和优化（+506 行，-部分代码）
- `src/services/ai/core/base-ai-service.ts`：优化基础 AI 服务（+7 行，-部分代码）
- `src/services/ai/providers/openai-service.ts`：优化 OpenAI 服务（+9 行，-部分代码）
- `src/services/ai/providers/gemini-service.ts`：优化 Gemini 服务（+2 行，-部分代码）
- `src/services/ai/tasks/index.ts`：导出配置服务（+1 行）
- `src/constants/ai/index.ts`：清理常量定义（-5 行）
- `src/constants/ai/prompts.ts`：移除旧提示词文件（-19 行）
- `package.json`：版本号更新至 0.7.9（+2 行，-1 行）
- `src/constants/version.ts`：版本号更新至 0.7.9（+2 行，-1 行）

### 新增功能统计
- **新增功能**: 4 项
- **改进优化**: 3 项
- **问题修复**: 2 项
- **代码变更**: 约 1279 行新增，1620 行删除
- **修改文件**: 14 个文件

---

## 🎯 用户体验改进

1. **AI 模型配置自动化**：新增的配置服务可以自动获取模型配置信息，减少了手动配置的工作量，提升了配置的准确性
2. **上下文窗口管理**：改进的上下文窗口处理确保了 AI 服务能够更好地利用模型能力，避免超出上下文限制
3. **重试机制增强**：润色和校对服务的重试机制提升了任务完成的可靠性，特别是在遇到临时错误时
4. **提示词优化**：精简和统一的提示词结构提升了 AI 任务执行的效率和准确性
5. **代码质量提升**：重构的代码结构消除了重复代码，提升了可维护性和可扩展性
6. **配置体验改进**：AI 模型对话框的增强使配置过程更加直观和便捷

---

## 🔄 升级建议

本次更新主要聚焦于：

1. **AI 模型配置自动化**：新增的配置服务可以自动获取模型配置信息，特别适合需要配置多个 AI 模型的用户
2. **上下文窗口管理**：改进的上下文窗口处理确保了更好的性能，特别适合使用大型上下文窗口模型的用户
3. **重试机制增强**：润色和校对服务的重试机制提升了任务完成的可靠性，特别适合处理大量内容的用户
4. **提示词优化**：精简和统一的提示词结构提升了 AI 任务执行的效率，所有用户都将受益
5. **代码质量改进**：重构的代码结构提升了应用的稳定性和可维护性

建议所有用户升级以获得更好的使用体验。特别是对于需要配置多个 AI 模型或使用大型上下文窗口模型的用户，配置自动化和上下文窗口管理将显著提升使用体验。

---

## 📚 相关文档

- 项目架构文档：`AGENTS.md`
- 翻译指南：`docs/TRANSLATION_GUIDE.md`
- 主题指南：`docs/THEME_GUIDE.md`
- 批量替换示例：`docs/batch-replace-examples.md`

---

## 🙏 致谢

感谢所有为本次版本做出贡献的开发者。

---

*本文档由自动化工具生成，如有疑问请提交 Issue。*

