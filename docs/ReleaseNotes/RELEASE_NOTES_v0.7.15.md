# 发布说明 - v0.7.15

## 版本信息
- **版本号**: 0.7.15
- **发布日期**: 2025年12月24日

---

## 🎉 新功能

### 1. AI 任务流程性能监控
- **性能指标追踪**：
  - 新增 `PerformanceMetrics` 接口，追踪任务执行各阶段的耗时
  - 支持统计规划时间、工作时间和完成时间
  - 支持统计工具调用次数和平均耗时
  - 支持追踪每个分块的处理时间
  - 提供详细的性能分析数据，帮助优化任务执行效率
- **性能数据收集**：
  - 自动收集任务执行过程中的性能指标
  - 支持在任务完成后查看性能统计信息
  - 为后续性能优化提供数据支持

### 2. 翻译上下文更新机制
- **规划上下文动态更新**：
  - 新增 `PlanningContextUpdate` 接口，支持在任务执行过程中更新规划上下文
  - 后续分块可以检测并更新共享的规划上下文（新术语、新角色、更新的记忆）
  - 实现 `detectPlanningContextUpdate` 函数，自动检测上下文更新需求
  - 优化多分块处理时的上下文共享机制，确保后续分块能够获取最新的上下文信息
- **上下文同步优化**：
  - 第一个分块的规划上下文会传递给后续分块
  - 后续分块发现新的术语、角色或记忆时，可以更新共享上下文
  - 提升多分块翻译任务的一致性和准确性

### 3. 术语翻译快速路径
- **性能优化**：
  - 实现快速路径机制，对于短文本（≤50字符）或无 bookId 的翻译请求，直接进行翻译
  - 跳过工具调用循环，显著提升简单翻译任务的执行速度
  - 优化迭代计数逻辑，确保快速路径和标准路径的计数准确性
- **智能路径选择**：
  - 自动判断是否使用快速路径，无需用户干预
  - 保持标准路径的完整功能（上下文获取、工具调用等）
  - 在保证翻译质量的前提下，提升简单场景的执行效率

### 4. 默认代理站点映射
- **代理配置增强**：
  - 新增 `DEFAULT_PROXY_SITE_MAPPING` 配置，为特定网站配置默认代理服务
  - 支持为 `syosetu.org` 和 `kakuyomu.jp` 配置默认代理列表
  - 新增 `corslol` 代理选项，提供更多代理选择
  - 优化代理选择逻辑，提升网站访问成功率
- **代理列表扩展**：
  - 在默认代理列表中添加 `corslol` 代理服务
  - 提供更丰富的代理选项，满足不同用户需求

### 5. AI 任务流程文档
- **完整文档体系**：
  - 新增 `TRANSLATION_AI_TASK_FLOW.md`，详细描述翻译相关 AI 任务的完整流程
  - 新增 `TRANSLATION_AI_TASK_FLOW_IMPROVEMENTS.md`，提供流程改进建议和优化方向
  - 包含状态机机制、提示词结构、工具调用机制、分块处理机制等详细说明
  - 提供最佳实践和关键代码位置参考
- **文档内容**：
  - 详细的任务类型说明（翻译、术语翻译、润色、校对）
  - 完整的流程图和代码示例
  - 错误处理与重试机制说明
  - 服务实现细节和接口定义

---

## 🔧 改进与优化

### AI 任务处理优化
- **工具结果截断优化**：
  - 实现智能截断策略，根据工具类型使用不同的截断方法
  - 优化术语表和角色表的截断逻辑，保留关键信息
  - 改进工具结果的展示方式，提升信息利用率
- **状态验证增强**：
  - 优化状态转换验证逻辑，提供更清晰的状态描述
  - 改进状态信息的获取和验证机制
  - 增强状态转换错误的检测和修复提示

### 章节服务改进
- **翻译导出优化**：
  - 改进章节翻译导出处理逻辑，优化导出内容格式
  - 增强导出功能的稳定性和可靠性
  - 优化导出内容的换行和格式处理

### 同步服务优化
- **Gist 同步改进**：
  - 优化进度追踪逻辑，提供更准确的同步进度信息
  - 改进同步任务的进度更新机制
- **数据同步增强**：
  - 优化同步逻辑和模型处理机制
  - 改进 SyncDataService 和相关 Store 的同步处理
  - 提升数据同步的稳定性和准确性

### 服务代码标准化
- **警告消息统一**：
  - 标准化跨 AI 服务的警告消息格式
  - 统一错误提示和用户反馈机制
  - 提升用户体验的一致性

### UI 优化
- **代理设置界面**：
  - 在 `ProxySettingsTab` 中禁用 DataTable 分页，简化界面操作
  - 优化代理设置的用户体验

---

## 🐛 问题修复

### 代理配置修复
- **代理 URL 修复**：
  - 修复 `corslol` 代理 URL 配置问题
  - 确保代理服务配置的正确性和可用性

### 测试改进
- **Mock 恢复优化**：
  - 优化内存助手测试中的 mock 恢复逻辑
  - 改进测试的隔离性和可靠性
  - 确保测试之间不会相互影响

---

## 📝 技术细节

### 主要修改文件
- `src/services/ai/tasks/utils/ai-task-helper.ts`：实现性能指标追踪、规划上下文更新机制、工具结果截断优化（+653 行，-部分代码）
- `src/services/ai/tasks/translation-service.ts`：集成规划上下文更新机制（+42 行，-部分代码）
- `src/services/ai/tasks/term-translation-service.ts`：实现快速路径机制，优化迭代计数（+12 行，-部分代码）
- `src/services/chapter-service.ts`：改进翻译导出处理逻辑（+71 行，-部分代码）
- `src/constants/proxy.ts`：新增默认代理站点映射和 corslol 代理（+21 行）
- `src/services/gist-sync-service.ts`：优化进度追踪逻辑（+16 行，-部分代码）
- `src/services/sync-data-service.ts`：优化同步逻辑和模型处理（+37 行，-部分代码）
- `src/services/ai/tasks/prompts/index.ts`：优化状态描述和提示词（+38 行，-部分代码）
- `src/services/ai/tasks/assistant-service.ts`：标准化警告消息（+8 行，-部分代码）
- `src/services/ai/tasks/polish-service.ts`：标准化警告消息（+4 行，-部分代码）
- `src/services/ai/tasks/proofreading-service.ts`：标准化警告消息（+4 行，-部分代码）
- `src/components/settings/ProxySettingsTab.vue`：禁用 DataTable 分页（+3 行，-部分代码）
- `src/stores/ai-models.ts`：优化模型处理逻辑（+10 行，-部分代码）
- `src/stores/settings.ts`：优化设置处理逻辑（+35 行，-部分代码）
- `docs/TRANSLATION_AI_TASK_FLOW.md`：新增 AI 任务流程文档（+760 行）
- `docs/TRANSLATION_AI_TASK_FLOW_IMPROVEMENTS.md`：新增流程改进建议文档（+696 行）
- `src/__tests__/ai-task-helper.truncateToolResult.test.ts`：新增工具结果截断测试（+574 行）
- `src/__tests__/chapter-service.test.ts`：更新章节服务测试（+50 行，-部分代码）
- `src/__tests__/memory-helper.test.ts`：优化 mock 恢复逻辑（+26 行，-部分代码）
- `src/__tests__/memory-service.test.ts`：更新内存服务测试（+102 行，-部分代码）
- `src/__tests__/include-memory-parameter.test.ts`：更新测试（+32 行，-部分代码）
- `package.json`：版本号更新至 0.7.15（+2 行，-1 行）
- `src/constants/version.ts`：版本号更新至 0.7.15（+2 行，-1 行）

### 新增功能统计
- **新增功能**: 5 项
- **改进优化**: 6 项
- **问题修复**: 2 项
- **代码变更**: 约 3305 行新增，241 行删除
- **修改文件**: 33 个文件

---

## 🎯 用户体验改进

1. **性能监控透明化**：新增的性能指标追踪功能使任务执行过程更加透明，用户可以了解任务各阶段的耗时情况
2. **翻译效率提升**：术语翻译快速路径和上下文更新机制显著提升了翻译任务的执行效率，特别是对于简单翻译场景
3. **上下文一致性**：规划上下文更新机制确保了多分块翻译任务中上下文信息的一致性，提升了翻译质量
4. **代理配置便捷性**：默认代理站点映射功能简化了代理配置流程，提升了网站访问的成功率
5. **文档完善性**：新增的 AI 任务流程文档为开发者提供了详细的参考，有助于理解系统架构和实现细节
6. **测试可靠性**：优化的测试机制提升了测试的隔离性和可靠性，确保代码质量

---

## 🔄 升级建议

本次更新主要聚焦于：

1. **性能优化**：新增的性能监控和快速路径机制显著提升了任务执行效率，所有用户都将受益
2. **上下文管理增强**：规划上下文更新机制提升了多分块翻译任务的质量，特别适合处理大型章节的用户
3. **代理配置优化**：默认代理站点映射功能简化了代理配置，特别适合需要访问日本小说网站的用户
4. **文档完善**：新增的文档为开发者提供了详细的参考，特别适合需要深入了解系统架构的开发者
5. **代码质量提升**：标准化的警告消息和优化的测试机制提升了代码质量和用户体验

建议所有用户升级以获得更好的使用体验。特别是对于需要处理大型章节或频繁使用术语翻译功能的用户，本次更新将显著提升使用体验。

---

## 📚 相关文档

- 项目架构文档：`AGENTS.md`
- 翻译指南：`docs/TRANSLATION_GUIDE.md`
- 主题指南：`docs/THEME_GUIDE.md`
- 批量替换示例：`docs/batch-replace-examples.md`
- **AI 任务流程文档**：`docs/TRANSLATION_AI_TASK_FLOW.md`（新增）
- **流程改进建议**：`docs/TRANSLATION_AI_TASK_FLOW_IMPROVEMENTS.md`（新增）

---

## 🙏 致谢

感谢所有为本次版本做出贡献的开发者。

---

*本文档由自动化工具生成，如有疑问请提交 Issue。*

