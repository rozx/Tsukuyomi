# 发布说明 - v0.7.13

## 版本信息
- **版本号**: 0.7.13
- **发布日期**: 2025年12月22日

---

## 🎉 新功能

### 1. 章节设置弹出窗口
- **章节设置管理**：
  - 新增 `ChapterSettingsPopover` 组件，提供便捷的章节和书籍设置管理
  - 支持全局设置（书籍级别）：过滤行首空格、规范化符号显示
  - 支持章节设置（章节级别）：翻译、润色、校对特殊指令
  - 提供清晰的标签页界面，区分全局设置和章节设置
  - 优化设置保存和加载逻辑，提升用户体验
- **翻译格式增强**：
  - 增强翻译格式处理，支持更灵活的显示和导出选项
  - 改进缩进处理逻辑，确保翻译质量和显示一致性

### 2. 独立分块提示词系统
- **分块处理优化**：
  - 实现独立的分块提示词系统，每个分块独立处理，避免上下文窗口溢出
  - 每个分块包含独立的提示信息，提醒 AI 使用工具获取上下文
  - 优化分块提示的构建逻辑，提升 AI 任务处理的准确性和效率
  - 改进分块间的状态管理，确保任务连续性
- **上下文获取优化**：
  - 增强上下文工具提醒，明确工具使用目的
  - 优化分块处理说明，帮助 AI 更好地理解任务结构

### 3. 任务状态验证和描述增强
- **状态转换验证**：
  - 新增当前状态信息获取和验证功能
  - 实现任务状态转换的严格验证，防止无效状态跳转
  - 提供清晰的状态描述，帮助 AI 理解当前阶段和下一步操作
  - 增强状态转换错误检测和修复提示
- **状态描述优化**：
  - 更新任务状态描述，明确各阶段的职责和转换规则
  - 改进状态转换提示的清晰度和准确性
  - 优化状态验证逻辑，提升任务执行的可靠性

### 4. 即时段落提取回调
- **润色和校对服务优化**：
  - 在 `PolishService` 和 `ProofreadingService` 中实现即时段落提取回调
  - 段落处理完成后立即触发回调，无需等待整个任务完成
  - 优化回调函数的流式处理，提升用户体验
  - 改进段落提取的实时性和准确性
- **翻译服务增强**：
  - 优化章节翻译功能，支持即时标题更新
  - 改进翻译任务的错误处理和 UI 更新逻辑
  - 增强翻译进度的实时反馈

### 5. 远程翻译合并功能
- **同步服务增强**：
  - 在 `sync-data-service` 中实现远程翻译合并功能
  - 支持段落翻译的智能合并，自动处理冲突和选择
  - 优化翻译数据的同步逻辑，确保数据一致性
  - 改进远程数据的合并策略，提升同步质量

### 6. 章节导出功能增强
- **导出功能优化**：
  - 增强章节导出功能，改进换行和内容处理逻辑
  - 优化 Windows 兼容性，确保导出文件在不同系统上的一致性
  - 改进导出内容的格式处理，提升导出质量
  - 修复导出过程中的换行和缩进处理问题

### 7. 书籍变更监听器
- **自动内容重载**：
  - 新增书籍变更监听器，自动检测书籍切换
  - 书籍切换时自动重新加载章节内容，提升用户体验
  - 优化内容加载逻辑，确保数据同步

---

## 🔧 改进与优化

### AI 任务处理优化
- **工具调用响应处理**：
  - 增强工具调用响应处理逻辑，改进错误检测和恢复
  - 优化工具调用的状态管理，提升任务执行的稳定性
  - 改进工具调用的错误处理和用户反馈
- **提示词系统优化**：
  - 更新术语创建工具描述，明确术语使用场景
  - 优化提示词结构，提升 AI 理解准确性
  - 改进工作流说明，增强任务执行效率

### 服务代码重构
- **章节翻译逻辑优化**：
  - 重构章节翻译逻辑，使用 async/await 模式
  - 改进错误处理机制，提升代码可维护性
  - 优化异步操作的流程控制，减少潜在问题
- **角色工具增强**：
  - 增强角色创建和更新工具的错误处理
  - 改进角色数据验证逻辑，提升数据质量
  - 优化角色操作的错误反馈

### UI 和交互优化
- **思考过程面板优化**：
  - 改进 `ThinkingProcessPanel` 组件的布局和样式
  - 优化面板的显示效果和交互体验
  - 提升思考过程信息的可读性

---

## 🐛 问题修复

### 章节导出修复
- **换行和内容处理**：
  - 修复章节导出中换行符处理不一致的问题
  - 改进内容处理逻辑，确保导出内容的一致性
  - 优化 Windows 系统下的换行处理，修复兼容性问题

### 任务状态管理修复
- **状态转换修复**：
  - 修复任务状态转换验证中的潜在问题
  - 改进状态信息的获取和验证逻辑
  - 优化状态转换错误的提示和修复机制

---

## 📝 技术细节

### 主要修改文件
- `src/services/ai/tasks/utils/ai-task-helper.ts`：实现独立分块提示词系统，增强状态验证（+200 行，-部分代码）
- `src/services/ai/tasks/prompts/index.ts`：新增当前状态信息获取函数，优化状态描述（+50 行，-部分代码）
- `src/services/ai/tasks/translation-service.ts`：优化章节翻译逻辑，实现即时标题更新（+100 行，-部分代码）
- `src/services/ai/tasks/polish-service.ts`：实现即时段落提取回调，优化回调处理（+80 行，-部分代码）
- `src/services/ai/tasks/proofreading-service.ts`：实现即时段落提取回调，优化回调处理（+80 行，-部分代码）
- `src/components/novel/ChapterSettingsPopover.vue`：新增章节设置弹出窗口组件（+178 行）
- `src/composables/book-details/useChapterTranslation.ts`：优化章节翻译逻辑，改进错误处理（+150 行，-部分代码）
- `src/services/chapter-service.ts`：增强章节导出功能，修复换行处理（+100 行，-部分代码）
- `src/services/sync-data-service.ts`：实现远程翻译合并功能（+80 行，-部分代码）
- `src/services/ai/tools/character-tools.ts`：增强角色工具错误处理（+50 行，-部分代码）
- `src/components/ai/ThinkingProcessPanel.vue`：优化布局和样式（+30 行，-部分代码）
- `src/composables/book-details/useChapterExport.ts`：优化导出功能（+20 行，-部分代码）
- `package.json`：版本号更新至 0.7.13（+2 行，-1 行）
- `src/constants/version.ts`：版本号更新至 0.7.13（+2 行，-1 行）

### 新增功能统计
- **新增功能**: 7 项
- **改进优化**: 3 项
- **问题修复**: 2 项
- **代码变更**: 约 1030 行新增，200 行删除
- **修改文件**: 14 个文件

---

## 🎯 用户体验改进

1. **章节设置便捷性**：新增的章节设置弹出窗口提供了集中管理翻译设置的方式，显著提升了设置管理的便捷性
2. **任务执行效率**：独立分块提示词系统和即时段落提取回调使任务执行更加高效，用户可以更快看到翻译结果
3. **状态管理清晰度**：增强的状态验证和描述使任务执行过程更加透明，用户可以更好地了解任务进度
4. **导出功能可靠性**：修复的导出问题确保了导出内容的一致性和跨平台兼容性
5. **数据同步质量**：远程翻译合并功能提升了数据同步的智能性和准确性
6. **错误处理改进**：优化的错误处理机制使应用更加稳定可靠

---

## 🔄 升级建议

本次更新主要聚焦于：

1. **章节设置管理**：新增的章节设置弹出窗口提供了更便捷的设置管理方式，特别适合需要精细控制翻译选项的用户
2. **任务执行优化**：独立分块提示词系统和即时回调显著提升了任务执行效率，所有用户都将受益
3. **状态管理增强**：改进的状态验证和描述使任务执行更加可靠，特别适合处理大型章节的用户
4. **导出功能修复**：修复的导出问题确保了导出内容的质量，特别适合需要导出翻译内容的用户
5. **数据同步改进**：远程翻译合并功能提升了数据同步的智能性，特别适合使用 Gist 同步的用户

建议所有用户升级以获得更好的使用体验。特别是对于需要处理大型章节或频繁使用导出功能的用户，本次更新将显著提升使用体验。

---

## 📚 相关文档

- 项目架构文档：`AGENTS.md`
- 翻译指南：`docs/TRANSLATION_GUIDE.md`
- 主题指南：`docs/THEME_GUIDE.md`
- 批量替换示例：`docs/batch-replace-examples.md`

---

## 🙏 致谢

感谢所有为本次版本做出贡献的开发者。

---

*本文档由自动化工具生成，如有疑问请提交 Issue。*

